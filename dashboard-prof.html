<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Enseignant – UniERP BF Premium</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <!-- Le CSS du thème est chargé dynamiquement par theme-toggle.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="js/theme-toggle.js?v=3.0"></script>
</head>
<body class="dark-theme">

    <div class="app-wrapper">
        <!-- SIDEBAR -->
        <aside class="sidebar-ultra" id="sidebar">
            <div class="sidebar-header">
                <div class="logo-ultra">
                    <div class="logo-icon-ultra">👨‍🏫</div>
                    <div class="logo-text-ultra">
                        <div class="logo-name-ultra">UniERP BF</div>
                        <div class="logo-tag-ultra">Espace Enseignant</div>
                    </div>
                </div>
            </div>

            <nav class="sidebar-nav-ultra">
                <div class="nav-section-ultra">
                    <div class="nav-label-ultra">PRINCIPAL</div>
                    <a href="javascript:void(0)" class="nav-item-ultra active" data-page="dashboard" onclick="navToUltra('dashboard',this)">
                        <span class="nav-icon-ultra">📊</span>
                        <span class="nav-text-ultra">Tableau de bord</span>
                        <span class="nav-indicator" style="background: linear-gradient(135deg, #10b981, #059669)"></span>
                    </a>
                </div>

                <div class="nav-section-ultra">
                    <div class="nav-label-ultra">ENSEIGNEMENT</div>
                    <a href="javascript:void(0)" class="nav-item-ultra" data-page="emploi" onclick="navToUltra('emploi',this)">
                        <span class="nav-icon-ultra">📅</span>
                        <span class="nav-text-ultra">Emploi du temps</span>
                    </a>
                    <a href="javascript:void(0)" class="nav-item-ultra" data-page="notes" onclick="navToUltra('notes',this)">
                        <span class="nav-icon-ultra">📝</span>
                        <span class="nav-text-ultra">Saisie des notes</span>
                    </a>
                    <a href="javascript:void(0)" class="nav-item-ultra" data-page="presences" onclick="navToUltra('presences',this)">
                        <span class="nav-icon-ultra">✅</span>
                        <span class="nav-text-ultra">Présences</span>
                    </a>
                    <a href="javascript:void(0)" class="nav-item-ultra" data-page="supports" onclick="navToUltra('supports',this)">
                        <span class="nav-icon-ultra">📄</span>
                        <span class="nav-text-ultra">Supports de cours</span>
                    </a>
                    <a href="javascript:void(0)" class="nav-item-ultra" data-page="etudiants" onclick="navToUltra('etudiants',this)">
                        <span class="nav-icon-ultra">🎓</span>
                        <span class="nav-text-ultra">Mes étudiants</span>
                    </a>
                    <a href="javascript:void(0)" class="nav-item-ultra" data-page="reclamations" onclick="navToUltra('reclamations',this)">
                        <span class="nav-icon-ultra">⚠️</span>
                        <span class="nav-text-ultra">Réclamations</span>
                        <span class="nav-badge-ultra" id="badgeReclamations">0</span>
                    </a>
                </div>
            </nav>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="main-ultra">
            <!-- TOPBAR -->
            <header class="topbar-ultra">
                <div class="topbar-left-ultra">
                    <button class="btn-menu-ultra" onclick="toggleSidebarUltra()">☰</button>
                    <div class="search-ultra">
                        <span class="search-icon-ultra">🔍</span>
                        <input type="text" class="search-input-ultra" placeholder="Rechercher...">
                    </div>
                </div>
                <div class="topbar-right-ultra">
                    <button class="topbar-btn-ultra">
                        <span>🔔</span>
                    </button>
                    <div class="user-menu-ultra" onclick="logout()">
                        <div class="user-avatar-ultra" style="background: linear-gradient(135deg, #10b981, #059669)">PR</div>
                        <div class="user-info-ultra">
                            <div class="user-name-ultra">Professeur</div>
                            <div class="user-role-ultra">Enseignant</div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- CONTENT -->
            <div class="content-ultra">
                <!-- PAGE: DASHBOARD -->
                <div class="page-ultra" id="page-dashboard">
                    <div class="page-header-ultra">
                        <div>
                            <h1 class="page-title-ultra">Tableau de bord</h1>
                            <p class="page-subtitle-ultra">Espace enseignant · Année 2024-2025</p>
                        </div>
                    </div>

                    <!-- STATS -->
                    <div class="stats-grid-ultra">
                        <div class="stat-card-ultra success-ultra">
                            <div class="stat-icon-ultra">📚</div>
                            <div class="stat-content-ultra">
                                <div class="stat-value-ultra-ultra" id="statMatieres">0</div>
                                <div class="stat-label-ultra-ultra">Matières enseignées</div>
                            </div>
                        </div>

                        <div class="stat-card-ultra primary-ultra">
                            <div class="stat-icon-ultra">🎓</div>
                            <div class="stat-content-ultra">
                                <div class="stat-value-ultra-ultra" id="statEtudiants">0</div>
                                <div class="stat-label-ultra-ultra">Étudiants</div>
                            </div>
                        </div>

                        <div class="stat-card-ultra warning-ultra">
                            <div class="stat-icon-ultra">📝</div>
                            <div class="stat-content-ultra">
                                <div class="stat-value-ultra-ultra" id="statNotes">0</div>
                                <div class="stat-label-ultra-ultra">Notes saisies</div>
                            </div>
                        </div>

                        <div class="stat-card-ultra primary-ultra">
                            <div class="stat-icon-ultra">📅</div>
                            <div class="stat-content-ultra">
                                <div class="stat-value-ultra-ultra" id="statCours">0</div>
                                <div class="stat-label-ultra-ultra">Cours cette semaine</div>
                            </div>
                        </div>
                    </div>

                    <!-- CONTENT CARDS -->
                    <div class="charts-grid-ultra">
                        <div class="card-ultra">
                            <div class="card-header-ultra">
                                <h3 class="card-title-ultra">📅 Emploi du temps</h3>
                            </div>
                            <div class="card-body-ultra">
                                <p style="color:rgba(255,255,255,0.6)">Vos cours de la semaine</p>
                            </div>
                        </div>

                        <div class="card-ultra">
                            <div class="card-header-ultra">
                                <h3 class="card-title-ultra">📊 Statistiques</h3>
                            </div>
                            <div class="card-body-ultra">
                                <p style="color:rgba(255,255,255,0.6)">Vue d'ensemble de vos cours</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PAGE: SUPPORTS -->
                <div class="page-ultra" id="page-supports" style="display:none">
                    <div class="page-header-ultra">
                        <div>
                            <h1 class="page-title-ultra">Supports de cours</h1>
                            <p class="page-subtitle-ultra">Gérez vos documents pédagogiques</p>
                        </div>
                        <div class="page-actions-ultra-ultra">
                            <button class="btn-ultra btn-primary-ultra-ultra" onclick="openModal('modalSupport')" style="background: linear-gradient(135deg, #10b981, #059669)">+ Ajouter un support</button>
                        </div>
                    </div>

                    <div class="card-ultra">
                        <div class="card-body-ultra" style="padding:0">
                            <table class="table-ultra">
                                <thead>
                                    <tr>
                                        <th>Titre</th>
                                        <th>Matière</th>
                                        <th>Type</th>
                                        <th>Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="tbodySupports">
                                    <tr><td colspan="5" style="text-align:center;padding:40px">Chargement...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- OTHER PAGES -->
                <div class="page-ultra" id="page-emploi" style="display:none">
                    <div class="page-header-ultra">
                        <h1 class="page-title-ultra">📅 Emploi du temps</h1>
                        <p class="page-subtitle-ultra">Votre planning de la semaine</p>
                    </div>
                    <div class="card-ultra">
                        <div class="card-body-ultra">
                            <div style="overflow-x:auto">
                                <table class="table-ultra">
                                    <thead>
                                        <tr>
                                            <th>Jour</th>
                                            <th>Heure</th>
                                            <th>Matière</th>
                                            <th>Filière</th>
                                            <th>Salle</th>
                                            <th>Type</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbodyEmploiProf">
                                        <tr><td colspan="6" style="text-align:center;padding:40px">Chargement...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PAGE: SAISIE DES NOTES -->
                <div class="page-ultra" id="page-notes" style="display:none">
                    <div class="page-header-ultra">
                        <div>
                            <h1 class="page-title-ultra">Saisie des Notes</h1>
                            <p class="page-subtitle-ultra">Saisissez les notes CC et Examen pour vos étudiants</p>
                        </div>
                    </div>

                    <!-- Filtres -->
                    <div class="card-ultra" style="margin-bottom:24px">
                        <div class="card-body-ultra">
                            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:16px">
                                <div class="form-group-ultra">
                                    <label class="form-label-ultra">Filière *</label>
                                    <select id="selectFiliereSaisie" class="form-input-ultra" onchange="chargerMatieresFiliereEtAnnees()" style="padding:12px 16px">
                                        <option value="">Sélectionner une filière...</option>
                                    </select>
                                </div>
                                <div class="form-group-ultra">
                                    <label class="form-label-ultra">Matière *</label>
                                    <select id="selectMatiereSaisie" class="form-input-ultra" onchange="chargerEtudiantsMatiere()" style="padding:12px 16px">
                                        <option value="">Sélectionner une matière...</option>
                                    </select>
                                </div>
                                <div class="form-group-ultra">
                                    <label class="form-label-ultra">Année académique *</label>
                                    <select id="selectAnneeSaisie" class="form-input-ultra" onchange="chargerEtudiantsMatiere()" style="padding:12px 16px">
                                        <option value="">Sélectionner une année...</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Contenu principal (visible après sélection) -->
                    <div id="contenuSaisieNotes" style="display:none">
                        
                        <!-- Statistiques -->
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px">
                            <div style="background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.2);border-radius:12px;padding:20px">
                                <div style="font-size:28px;font-weight:700;color:#10b981" id="statNbEtudiantsSaisie">0</div>
                                <div style="font-size:13px;color:rgba(255,255,255,0.7);margin-top:4px">Étudiants</div>
                            </div>
                            <div style="background:rgba(99,102,241,0.1);border:1px solid rgba(99,102,241,0.2);border-radius:12px;padding:20px">
                                <div style="font-size:28px;font-weight:700;color:#6366f1" id="statNotesSaisiesSaisie">0</div>
                                <div style="font-size:13px;color:rgba(255,255,255,0.7);margin-top:4px">Notes saisies</div>
                            </div>
                            <div style="background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.2);border-radius:12px;padding:20px">
                                <div style="font-size:28px;font-weight:700;color:#f59e0b" id="statNotesPublieesSaisie">0</div>
                                <div style="font-size:13px;color:rgba(255,255,255,0.7);margin-top:4px">Notes publiées</div>
                            </div>
                        </div>

                        <!-- Tableau de saisie -->
                        <div class="card-ultra">
                            <div class="card-header-ultra">
                                <h3 class="card-title-ultra">📝 Saisie des notes</h3>
                                <div style="display:flex;gap:12px">
                                    <button class="btn-ultra btn-success-ultra" onclick="sauvegarderToutesLesNotes()" style="background: linear-gradient(135deg, #10b981, #059669)">
                                        💾 Sauvegarder tout
                                    </button>
                                    <button class="btn-ultra btn-primary-ultra-ultra" onclick="publierNotesMatiere()" style="background: linear-gradient(135deg, #6366f1, #4f46e5)">
                                        📤 Publier les notes
                                    </button>
                                </div>
                            </div>
                            <div class="card-body-ultra">
                                <div style="overflow-x:auto">
                                    <table class="table-ultra">
                                        <thead>
                                            <tr>
                                                <th style="width:50px">#</th>
                                                <th>Matricule</th>
                                                <th>Nom complet</th>
                                                <th style="width:120px">Note CC /20</th>
                                                <th style="width:120px">Note Examen /20</th>
                                                <th style="width:120px">Moyenne /20</th>
                                                <th style="width:100px">Statut</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tbodySaisieNotes">
                                            <tr><td colspan="7" style="text-align:center;padding:40px;color:rgba(255,255,255,0.5)">
                                                Sélectionnez une filière, une matière et une année pour commencer
                                            </td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- PAGE: PRÉSENCES -->
                <div class="page-ultra" id="page-presences" style="display:none">
                    <div class="page-header-ultra">
                        <div>
                            <h1 class="page-title-ultra">Gestion des Présences</h1>
                            <p class="page-subtitle-ultra">Enregistrez les présences de vos étudiants</p>
                        </div>
                    </div>

                    <!-- Filtres -->
                    <div class="card-ultra" style="margin-bottom:24px">
                        <div class="card-body-ultra">
                            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:16px">
                                <div class="form-group-ultra">
                                    <label class="form-label-ultra">Filière *</label>
                                    <select id="selectFilierePresence" class="form-input-ultra" onchange="chargerMatieresPresence()" style="padding:12px 16px">
                                        <option value="">Sélectionner une filière...</option>
                                    </select>
                                </div>
                                <div class="form-group-ultra">
                                    <label class="form-label-ultra">Matière *</label>
                                    <select id="selectMatierePresence" class="form-input-ultra" onchange="chargerEtudiantsPresence()" style="padding:12px 16px">
                                        <option value="">Sélectionner une matière...</option>
                                    </select>
                                </div>
                                <div class="form-group-ultra">
                                    <label class="form-label-ultra">Date du cours *</label>
                                    <input type="date" id="inputDatePresence" class="form-input-ultra" onchange="chargerEtudiantsPresence()" style="padding:12px 16px">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Contenu principal (visible après sélection) -->
                    <div id="contenuPresences" style="display:none">
                        
                        <!-- Statistiques -->
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px">
                            <div style="background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.2);border-radius:12px;padding:20px">
                                <div style="font-size:28px;font-weight:700;color:#10b981" id="statNbEtudiantsPresence">0</div>
                                <div style="font-size:13px;color:rgba(255,255,255,0.7);margin-top:4px">Étudiants</div>
                            </div>
                            <div style="background:rgba(99,102,241,0.1);border:1px solid rgba(99,102,241,0.2);border-radius:12px;padding:20px">
                                <div style="font-size:28px;font-weight:700;color:#6366f1" id="statPresents">0</div>
                                <div style="font-size:13px;color:rgba(255,255,255,0.7);margin-top:4px">Présents</div>
                            </div>
                            <div style="background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.2);border-radius:12px;padding:20px">
                                <div style="font-size:28px;font-weight:700;color:#ef4444" id="statAbsents">0</div>
                                <div style="font-size:13px;color:rgba(255,255,255,0.7);margin-top:4px">Absents</div>
                            </div>
                            <div style="background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.2);border-radius:12px;padding:20px">
                                <div style="font-size:28px;font-weight:700;color:#f59e0b" id="statTauxPresence">0%</div>
                                <div style="font-size:13px;color:rgba(255,255,255,0.7);margin-top:4px">Taux de présence</div>
                            </div>
                        </div>

                        <!-- Tableau de présences -->
                        <div class="card-ultra">
                            <div class="card-header-ultra">
                                <h3 class="card-title-ultra">✅ Feuille de présence</h3>
                                <div style="display:flex;gap:12px">
                                    <button class="btn-ultra" onclick="marquerTousPresents()" style="background: linear-gradient(135deg, #10b981, #059669)">
                                        ✅ Tous présents
                                    </button>
                                    <button class="btn-ultra" onclick="marquerTousAbsents()" style="background: linear-gradient(135deg, #ef4444, #dc2626)">
                                        ❌ Tous absents
                                    </button>
                                    <button class="btn-ultra btn-primary-ultra-ultra" onclick="sauvegarderPresences()" style="background: linear-gradient(135deg, #6366f1, #4f46e5)">
                                        💾 Sauvegarder
                                    </button>
                                </div>
                            </div>
                            <div class="card-body-ultra">
                                <div style="overflow-x:auto">
                                    <table class="table-ultra">
                                        <thead>
                                            <tr>
                                                <th style="width:60px;text-align:center">#</th>
                                                <th style="width:150px">Matricule</th>
                                                <th>Nom complet</th>
                                                <th style="width:120px;text-align:center">Présence</th>
                                                <th style="width:120px;text-align:center">Justifié</th>
                                                <th style="width:250px">Observation</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tbodyPresences">
                                            <tr>
                                                <td colspan="6" style="text-align:center;padding:40px;color:rgba(255,255,255,0.5)">
                                                    Sélectionnez une filière, une matière et une date pour voir la liste des étudiants
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="page-ultra" id="page-etudiants" style="display:none">
                    <div class="page-header-ultra">
                        <div>
                            <h1 class="page-title-ultra">Mes étudiants</h1>
                            <p class="page-subtitle-ultra">Étudiants inscrits dans vos matières</p>
                        </div>
                    </div>

                    <!-- Filtres -->
                    <div class="card-ultra" style="margin-bottom:24px">
                        <div class="card-body-ultra">
                            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px">
                                <div>
                                    <input type="text" id="searchEtudiantsProf" class="search-input-ultra" placeholder="🔍 Rechercher..." 
                                        style="width:100%;padding:12px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:#fff"
                                        onkeyup="filtrerEtudiantsProf()">
                                </div>
                                <div>
                                    <select id="filterMatiereProf" class="form-input-ultra" onchange="filtrerEtudiantsProf()" style="width:100%;padding:12px 16px">
                                        <option value="">📚 Toutes mes matières</option>
                                    </select>
                                </div>
                                <div>
                                    <select id="filterNiveauProf" class="form-input-ultra" onchange="filtrerEtudiantsProf()" style="width:100%;padding:12px 16px">
                                        <option value="">🎓 Tous les niveaux</option>
                                        <option value="L1">Licence 1</option>
                                        <option value="L2">Licence 2</option>
                                        <option value="L3">Licence 3</option>
                                        <option value="M1">Master 1</option>
                                        <option value="M2">Master 2</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Statistiques -->
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;margin-bottom:24px">
                        <div style="padding:16px;background:rgba(16,185,129,0.1);border-radius:12px;border:1px solid rgba(16,185,129,0.2);text-align:center">
                            <div style="font-size:24px;font-weight:700;color:#10b981" id="statTotalEtudiantsProf">0</div>
                            <div style="font-size:12px;color:rgba(255,255,255,0.6)">Total étudiants</div>
                        </div>
                        <div style="padding:16px;background:rgba(99,102,241,0.1);border-radius:12px;border:1px solid rgba(99,102,241,0.2);text-align:center">
                            <div style="font-size:24px;font-weight:700;color:#6366f1" id="statFilieresProf">0</div>
                            <div style="font-size:12px;color:rgba(255,255,255,0.6)">Filières</div>
                        </div>
                    </div>

                    <!-- Tableau -->
                    <div class="card-ultra">
                        <div class="card-body-ultra">
                            <div style="overflow-x:auto">
                                <table class="table-ultra">
                                    <thead>
                                        <tr>
                                            <th>Matricule</th>
                                            <th>Nom complet</th>
                                            <th>Filière</th>
                                            <th>Niveau</th>
                                            <th>Email</th>
                                            <th>Téléphone</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbodyEtudiantsProf">
                                        <tr><td colspan="6" style="text-align:center;padding:40px">Chargement...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PAGE: RÉCLAMATIONS -->
                <div class="page-ultra" id="page-reclamations" style="display:none">
                    <div class="page-header-ultra">
                        <div>
                            <h1 class="page-title-ultra">Réclamations sur les notes</h1>
                            <p class="page-subtitle-ultra">Réclamations de vos étudiants</p>
                        </div>
                    </div>

                    <div class="card-ultra">
                        <div class="card-body-ultra">
                            <!-- Filtres -->
                            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px">
                                <div>
                                    <select id="filtreStatutReclamationProf" class="form-input-ultra" onchange="filtrerReclamationsProf()" style="width:100%;padding:12px 16px">
                                        <option value="">Tous les statuts</option>
                                        <option value="en_attente">En attente</option>
                                        <option value="resolue">Résolue</option>
                                        <option value="rejetee">Rejetée</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Tableau -->
                            <div style="overflow-x:auto">
                                <table class="table-ultra">
                                    <thead>
                                        <tr>
                                            <th>Étudiant</th>
                                            <th>Matière</th>
                                            <th>Note CC</th>
                                            <th>Note Examen</th>
                                            <th>Moyenne</th>
                                            <th>Date</th>
                                            <th>Statut</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbodyReclamationsProf">
                                        <tr><td colspan="8" style="text-align:center;padding:40px">Chargement...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MODAL VOIR RÉCLAMATION -->
                <div class="modal-ultra" id="modalVoirReclamationProf">
                    <div class="modal-content-ultra">
                        <div class="modal-header-ultra">
                            <h3>⚠️ Détails de la réclamation</h3>
                            <span class="modal-close-ultra" onclick="closeModal('modalVoirReclamationProf')">&times;</span>
                        </div>
                        <div class="modal-body-ultra">
                            <div id="detailsReclamationProf" style="line-height:1.8">
                                <!-- Rempli dynamiquement -->
                            </div>
                        </div>
                        <div class="modal-footer-ultra">
                            <button type="button" class="btn-ultra btn-ghost-ultra" onclick="closeModal('modalVoirReclamationProf')">Fermer</button>
                        </div>
                    </div>
                </div>

                <!-- MODAL TRAITER RÉCLAMATION -->
                <div class="modal-ultra" id="modalTraiterReclamation">
                    <div class="modal-content-ultra" style="max-width:700px">
                        <div class="modal-header-ultra">
                            <h3>⚠️ Traiter la réclamation</h3>
                            <span class="modal-close-ultra" onclick="closeModal('modalTraiterReclamation')">&times;</span>
                        </div>
                        <div class="modal-body-ultra">
                            <div id="reclamationInfo" style="padding:15px;background:rgba(255,255,255,0.05);border-radius:8px;margin-bottom:20px">
                                <!-- Info réclamation -->
                            </div>
                            
                            <div style="padding:15px;background:rgba(255,255,255,0.05);border-radius:8px;margin-bottom:20px">
                                <strong style="font-size:13px;color:rgba(255,255,255,0.7)">DESCRIPTION:</strong>
                                <p id="reclamationDescription" style="margin-top:10px;color:#fff"></p>
                            </div>
                            
                            <form id="formTraiterReclamation" onsubmit="envoyerTraitementReclamation(event)">
                                <div class="form-group-ultra">
                                    <label class="form-label-ultra">Décision *</label>
                                    <select id="decisionReclamation" required class="form-input-ultra">
                                        <option value="">Choisir...</option>
                                        <option value="resolue">Accepter (Résoudre)</option>
                                        <option value="rejetee">Rejeter</option>
                                    </select>
                                </div>
                                
                                <div class="form-group-ultra">
                                    <label class="form-label-ultra">Réponse à l'étudiant *</label>
                                    <textarea id="reponseReclamation" rows="4" required class="form-input-ultra" placeholder="Expliquez votre décision..."></textarea>
                                </div>
                                
                                <div id="correctionNote" style="display:none;padding:20px;background:rgba(16,185,129,0.1);border-radius:12px;border:1px solid rgba(16,185,129,0.2);margin-top:20px">
                                    <h4 style="margin-bottom:16px;color:#10b981">✏️ Correction de la note</h4>
                                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
                                        <div class="form-group-ultra">
                                            <label class="form-label-ultra">Nouvelle note CC</label>
                                            <input type="number" id="nouvelleNoteCC" min="0" max="20" step="0.5" class="form-input-ultra" placeholder="Ex: 15">
                                        </div>
                                        <div class="form-group-ultra">
                                            <label class="form-label-ultra">Nouvelle note Examen</label>
                                            <input type="number" id="nouvelleNoteExamen" min="0" max="20" step="0.5" class="form-input-ultra" placeholder="Ex: 16">
                                        </div>
                                    </div>
                                    <p style="font-size:13px;color:rgba(255,255,255,0.7);margin-top:12px">
                                        💡 La moyenne sera recalculée automatiquement
                                    </p>
                                </div>
                                
                                <div class="modal-footer-ultra">
                                    <button type="button" class="btn-ultra btn-ghost-ultra" onclick="closeModal('modalTraiterReclamation')">Annuler</button>
                                    <button type="submit" class="btn-ultra btn-primary-ultra-ultra">Envoyer</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODAL SUPPORT -->
    <div class="modal-ultra" id="modalSupport" style="display:none">
        <div class="modal-content-ultra">
            <div class="modal-header-ultra">
                <h3>📄 Ajouter un support</h3>
                <span class="modal-close-ultra" onclick="closeModal('modalSupport')">&times;</span>
            </div>
            <div class="modal-body-ultra">
                <form id="formSupport" onsubmit="ajouterSupport(event)">
                    <div class="form-group-ultra">
                        <label class="form-label-ultra">Titre</label>
                        <input type="text" name="titre" required class="form-input-ultra">
                    </div>
                    <div class="form-group-ultra">
                        <label class="form-label-ultra">Matière</label>
                        <select name="matiere" required id="selectMatiereSupport" class="form-input-ultra">
                            <option value="">Sélectionner</option>
                        </select>
                    </div>
                    <div class="form-group-ultra">
                        <label class="form-label-ultra">Type</label>
                        <select name="type_support" required class="form-input-ultra">
                            <option value="cours">Cours</option>
                            <option value="td">TD</option>
                            <option value="tp">TP</option>
                            <option value="examen_corrige">Examen corrigé</option>
                            <option value="ressource">Ressource</option>
                        </select>
                    </div>
                    <div class="form-group-ultra">
                        <label class="form-label-ultra">Fichier (optionnel)</label>
                        <input type="file" name="fichier" accept=".pdf,.doc,.docx,.ppt,.pptx" class="form-input-ultra">
                    </div>
                    <div class="form-group-ultra">
                        <label class="form-label-ultra">Description</label>
                        <textarea name="description" rows="3" class="form-input-ultra"></textarea>
                    </div>
                    <div class="form-group-ultra">
                        <label style="display:flex;align-items:center;gap:8px;color:rgba(255,255,255,0.8)">
                            <input type="checkbox" name="visible" checked>
                            <span>Visible pour les étudiants</span>
                        </label>
                    </div>
                    <div class="modal-footer-ultra">
                        <button type="button" class="btn-ultra btn-ghost-ultra" onclick="closeModal('modalSupport')">Annuler</button>
                        <button type="submit" class="btn-ultra btn-primary-ultra-ultra" style="background: linear-gradient(135deg, #10b981, #059669)">Publier</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL: CRÉER/MODIFIER ÉVALUATION -->
    <div class="modal-ultra" id="modalEvaluation" style="display:none">
        <div class="modal-content-ultra" style="max-width:600px">
            <div class="modal-header-ultra">
                <h3 id="modalEvaluationTitle">📝 Nouvelle évaluation</h3>
                <span class="modal-close-ultra" onclick="closeModal('modalEvaluation')">&times;</span>
            </div>
            <div class="modal-body-ultra">
                <form id="formEvaluation" onsubmit="sauvegarderEvaluation(event)">
                    <input type="hidden" id="editEvalId">
                    
                    <div class="form-group-ultra">
                        <label class="form-label-ultra">Titre *</label>
                        <input type="text" name="titre" id="editEvalTitre" required class="form-input-ultra" 
                            placeholder="Ex: Devoir 1 - Algorithmique">
                    </div>

                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
                        <div class="form-group-ultra">
                            <label class="form-label-ultra">Type *</label>
                            <select name="type_evaluation" id="editEvalType" required class="form-input-ultra">
                                <option value="devoir">📝 Devoir</option>
                                <option value="Poppinsrogation">📄 Poppinsrogation</option>
                                <option value="tp">🔬 TP</option>
                                <option value="projet">💼 Projet</option>
                                <option value="examen">📋 Examen</option>
                                <option value="oral">🎤 Oral</option>
                            </select>
                        </div>
                        <div class="form-group-ultra">
                            <label class="form-label-ultra">Catégorie *</label>
                            <select name="categorie" id="editEvalCategorie" required class="form-input-ultra">
                                <option value="cc">CC (40%)</option>
                                <option value="examen">Examen (60%)</option>
                            </select>
                        </div>
                    </div>

                    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px">
                        <div class="form-group-ultra">
                            <label class="form-label-ultra">Coefficient *</label>
                            <input type="number" name="coefficient" id="editEvalCoef" required class="form-input-ultra" 
                                min="1" max="10" value="1">
                        </div>
                        <div class="form-group-ultra">
                            <label class="form-label-ultra">Note sur *</label>
                            <input type="number" name="note_sur" id="editEvalNoteSur" required class="form-input-ultra" 
                                min="1" max="100" value="20" step="0.01">
                        </div>
                        <div class="form-group-ultra">
                            <label class="form-label-ultra">Date *</label>
                            <input type="date" name="date_evaluation" id="editEvalDate" required class="form-input-ultra">
                        </div>
                    </div>

                    <div class="form-group-ultra">
                        <label class="form-label-ultra">Description</label>
                        <textarea name="description" id="editEvalDescription" class="form-input-ultra" rows="3" 
                            placeholder="Description de l'évaluation..."></textarea>
                    </div>

                    <div class="modal-footer-ultra">
                        <button type="button" class="btn-ultra btn-ghost-ultra" onclick="closeModal('modalEvaluation')">Annuler</button>
                        <button type="submit" class="btn-ultra btn-primary-ultra-ultra" style="background: linear-gradient(135deg, #10b981, #059669)">Enregistrer</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL: SAISIR LES NOTES D'UNE ÉVALUATION -->
    <div class="modal-ultra" id="modalSaisieNotes" style="display:none">
        <div class="modal-content-ultra" style="max-width:1000px;max-height:90vh;overflow-y:auto">
            <div class="modal-header-ultra">
                <h3 id="modalSaisieTitle">📝 Saisie des notes</h3>
                <span class="modal-close-ultra" onclick="closeModal('modalSaisieNotes')">&times;</span>
            </div>
            <div class="modal-body-ultra">
                <div id="infoEvaluation" style="background:rgba(99,102,241,0.1);padding:16px;border-radius:8px;margin-bottom:20px">
                    <!-- Info évaluation -->
                </div>
                
                <div style="margin-bottom:16px;display:flex;justify-content:space-between;align-items:center">
                    <div>
                        <span id="progressNotes" style="color:rgba(255,255,255,0.7)">0/0 notes saisies</span>
                    </div>
                    <button class="btn-ultra btn-primary-ultra-ultra" onclick="sauvegarderToutesNotesEval()" style="background: linear-gradient(135deg, #10b981, #059669)">
                        💾 Sauvegarder tout
                    </button>
                </div>

                <div style="overflow-x:auto">
                    <table class="table-ultra">
                        <thead>
                            <tr>
                                <th style="width:50px">#</th>
                                <th>Matricule</th>
                                <th>Nom complet</th>
                                <th style="width:150px">Note</th>
                                <th style="width:100px">Absent</th>
                                <th style="width:200px">Commentaire</th>
                            </tr>
                        </thead>
                        <tbody id="tbodyNotesEval">
                            <!-- Lignes étudiants -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Charger les scripts externes d'abord -->
    <script src="js/mock-data.js?v=7"></script>
    <script src="js/api.js?v=7"></script>
    <script src="js/fix-navigation.js?v=7"></script>
    <script src="js/theme-toggle.js?v=7"></script>

    <!-- Puis le script inline qui utilise ces fonctions -->
    <script>
        // PAS de vérification au chargement - on fait confiance à la redirection depuis index.html
        // La vérification se fera lors des appels API qui nécessitent l'authentification
        
        window.navToUltra = function(page, el) {
            console.log('🔄 Navigation vers:', page);
            document.querySelectorAll('.page-ultra').forEach(p => p.style.display = 'none');
            const target = document.getElementById('page-' + page);
            if (target) {
                target.style.display = 'block';
                console.log('✅ Page affichée:', page);
            } else {
                console.error('❌ Page non trouvée:', 'page-' + page);
            }
            
            document.querySelectorAll('.nav-item-ultra').forEach(i => i.classList.remove('active'));
            if (el) el.classList.add('active');

            // Charger les données spécifiques à la page
            if (page === 'etudiants') {
                chargerMesEtudiants();
            } else if (page === 'supports') {
                chargerSupports();
            } else if (page === 'notes') {
                chargerMatieresNotes();
            } else if (page === 'emploi') {
                chargerEmploiProf();
            }
        }

        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('open');
                document.body.style.overflow = 'hidden';
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('open');
                document.body.style.overflow = '';
            }
        }

        function showToast(message, type = 'info') {
            const icons = { success: '✅', danger: '❌', warning: '⚠️', info: 'ℹ️' };
            let container = document.getElementById('toast-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toast-container';
                container.style.cssText = 'position:fixed;top:20px;right:20px;z-index:9999;display:flex;flex-direction:column;gap:10px;';
                document.body.appendChild(container);
            }
            const toast = document.createElement('div');
            const colors = { success: '#059669', danger: '#dc2626', warning: '#d97706', info: '#2563eb' };
            toast.style.cssText = `background:rgba(10,14,39,0.95);border-radius:12px;padding:14px 18px;box-shadow:0 8px 32px rgba(0,0,0,.3);display:flex;align-items:center;gap:12px;min-width:280px;max-width:400px;border-left:4px solid ${colors[type]};animation:slideIn .3s ease;backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.1)`;
            toast.innerHTML = `<span style="font-size:18px">${icons[type]}</span><span style="font-size:14px;font-weight:500;flex:1;color:#fff">${message}</span><span onclick="this.parentElement.remove()" style="cursor:poPoppins;color:#94a3b8;flex-shrink:0;font-size:18px">✕</span>`;
            container.appendChild(toast);
            setTimeout(() => { if (toast.parentElement) toast.remove(); }, 3500);
        }

        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            const date = new Date(dateStr);
            return date.toLocaleDateString('fr-FR');
        }

        async function chargerMatieres() {
            try {
                const dashboard = await API.getDashboardProf();
                if (dashboard && dashboard.matieres) {
                    const select = document.getElementById('selectMatiereSupport');
                    select.innerHTML = '<option value="">Sélectionner</option>' + 
                        dashboard.matieres.map(m => `<option value="${m.id}">${m.nom}</option>`).join('');
                }
            } catch (err) {
                console.error('Erreur:', err);
            }
        }

        async function chargerSupports() {
            try {
                const supports = await API.getSupports();
                const tbody = document.getElementById('tbodySupports');
                
                if (supports && supports.length > 0) {
                    tbody.innerHTML = supports.map(s => `
                        <tr>
                            <td style="font-weight:600">${s.titre}</td>
                            <td>${s.matiere_nom || 'N/A'}</td>
                            <td><span class="badge-ultra success">${s.type_support}</span></td>
                            <td>${formatDate(s.date_depot)}</td>
                            <td>
                                <button class="btn-ultra btn-ghost-ultra btn-sm-ultra">📥</button>
                                <button class="btn-ultra btn-ghost-ultra btn-sm-ultra" onclick="supprimerSupport(${s.id})">🗑️</button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:40px;color:rgba(255,255,255,0.5)">Aucun support</td></tr>';
                }
            } catch (err) {
                console.error('Erreur:', err);
            }
        }

        async function ajouterSupport(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);

            try {
                const me = await API.getMe();
                const uploadData = new FormData();
                uploadData.append('titre', formData.get('titre'));
                uploadData.append('matiere', formData.get('matiere'));
                uploadData.append('enseignant', me.enseignant.id);
                uploadData.append('type_support', formData.get('type_support'));
                uploadData.append('description', formData.get('description') || '');
                uploadData.append('visible', formData.get('visible') ? 'true' : 'false');
                
                const fichier = formData.get('fichier');
                if (fichier && fichier.size > 0) {
                    uploadData.append('fichier', fichier);
                }

                await API.createSupport(uploadData);
                showToast('Support publié !', 'success');
                closeModal('modalSupport');
                form.reset();
                chargerSupports();
            } catch (err) {
                showToast('Erreur : ' + err.message, 'danger');
            }
        }

        async function supprimerSupport(id) {
            if (!confirm('Supprimer ce support ?')) return;
            try {
                await API.deleteSupport(id);
                showToast('Support supprimé', 'success');
                chargerSupports();
            } catch (err) {
                showToast('Erreur', 'danger');
            }
        }

        // Charger l'emploi du temps de l'enseignant
        async function chargerEmploiProf() {
            try {
                const tbody = document.getElementById('tbodyEmploiProf');
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px">Chargement...</td></tr>';

                // Récupérer les données du dashboard pour avoir les matières de l'enseignant
                const dashboard = await API.getDashboardProf();
                const mesMatieres = dashboard.matieres || [];
                const mesMatieresIds = mesMatieres.map(m => m.id);

                // Récupérer tous les emplois du temps
                const emplois = await API.getEmploisDuTemps();
                
                // Filtrer pour ne garder que les cours de l'enseignant
                const mesEmplois = emplois.filter(e => mesMatieresIds.includes(e.matiere));

                // Ordre des jours
                const ordreJours = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi', 'Dimanche'];
                
                // Trier par jour puis par heure
                mesEmplois.sort((a, b) => {
                    const jourA = ordreJours.indexOf(a.jour);
                    const jourB = ordreJours.indexOf(b.jour);
                    if (jourA !== jourB) return jourA - jourB;
                    return a.heure_debut.localeCompare(b.heure_debut);
                });

                if (mesEmplois.length > 0) {
                    tbody.innerHTML = mesEmplois.map(e => {
                        // Trouver le nom de la filière
                        const matiere = mesMatieres.find(m => m.id === e.matiere);
                        const filiereNom = matiere ? matiere.filiere_nom : 'N/A';
                        
                        return `
                            <tr>
                                <td><strong>${e.jour}</strong></td>
                                <td>${e.heure_debut} - ${e.heure_fin}</td>
                                <td>${e.matiere_nom}</td>
                                <td>${filiereNom}</td>
                                <td><span class="badge-ultra primary">${e.salle}</span></td>
                                <td><span class="badge-ultra success">Cours</span></td>
                            </tr>
                        `;
                    }).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;color:rgba(255,255,255,0.5)">Aucun cours programmé</td></tr>';
                }
            } catch (err) {
                console.error('Erreur chargement emploi:', err);
                const tbody = document.getElementById('tbodyEmploiProf');
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;color:rgba(255,255,255,0.5)">Erreur de chargement</td></tr>';
            }
        }

        let tousLesEtudiantsProf = [];
        let etudiantsProfFiltres = [];
        let mesMatieres = [];

        async function chargerMesEtudiants() {
            try {
                const dashboard = await API.getDashboardProf();
                mesMatieres = dashboard.matieres || [];

                // Récupérer toutes les filières de mes matières
                const filieresIds = [...new Set(mesMatieres.map(m => m.filiere))];
                
                // Récupérer tous les étudiants de ces filières
                const promesses = filieresIds.map(filiereId => API.getEtudiants({ filiere: filiereId }));
                const resultats = await Promise.all(promesses);
                
                // Fusionner tous les étudiants et supprimer les doublons
                const etudiantsMap = new Map();
                resultats.flat().forEach(e => {
                    if (!etudiantsMap.has(e.id)) {
                        etudiantsMap.set(e.id, e);
                    }
                });
                
                tousLesEtudiantsProf = Array.from(etudiantsMap.values());
                etudiantsProfFiltres = tousLesEtudiantsProf;

                // Remplir le filtre des matières
                document.getElementById('filterMatiereProf').innerHTML = 
                    '<option value="">📚 Toutes mes matières</option>' +
                    mesMatieres.map(m => `<option value="${m.filiere}">${m.nom}</option>`).join('');

                // Mettre à jour les stats
                document.getElementById('statTotalEtudiantsProf').textContent = tousLesEtudiantsProf.length;
                document.getElementById('statFilieresProf').textContent = filieresIds.length;
                document.getElementById('statEtudiants').textContent = tousLesEtudiantsProf.length;

                afficherEtudiantsProf();
            } catch (err) {
                console.error('Erreur:', err);
                showToast('Erreur de chargement: ' + err.message, 'danger');
                document.getElementById('tbodyEtudiantsProf').innerHTML = 
                    '<tr><td colspan="6" style="text-align:center;padding:40px;color:rgba(255,255,255,0.5)">Erreur de chargement</td></tr>';
            }
        }

        function filtrerEtudiantsProf() {
            const searchValue = document.getElementById('searchEtudiantsProf').value.toLowerCase();
            const filterMatiere = document.getElementById('filterMatiereProf').value;
            const filterNiveau = document.getElementById('filterNiveauProf').value;

            etudiantsProfFiltres = tousLesEtudiantsProf.filter(e => {
                const matchSearch = !searchValue || 
                    e.matricule.toLowerCase().includes(searchValue) ||
                    e.prenom.toLowerCase().includes(searchValue) ||
                    e.nom.toLowerCase().includes(searchValue) ||
                    e.email.toLowerCase().includes(searchValue);
                
                const matchMatiere = !filterMatiere || e.filiere == filterMatiere;
                const matchNiveau = !filterNiveau || e.niveau === filterNiveau;

                return matchSearch && matchMatiere && matchNiveau;
            });

            afficherEtudiantsProf();
        }

        function afficherEtudiantsProf() {
            const tbody = document.getElementById('tbodyEtudiantsProf');
            
            if (etudiantsProfFiltres.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;color:rgba(255,255,255,0.5)">Aucun étudiant trouvé</td></tr>';
                return;
            }

            tbody.innerHTML = etudiantsProfFiltres.map(e => `
                <tr>
                    <td data-label="Matricule" style="font-weight:600">${e.matricule}</td>
                    <td data-label="Nom">${e.prenom} ${e.nom}</td>
                    <td data-label="Filière">${e.filiere_nom || 'N/A'}</td>
                    <td data-label="Niveau"><span class="badge-ultra primary">${e.niveau}</span></td>
                    <td data-label="Email">${e.email}</td>
                    <td data-label="Téléphone">${e.telephone || 'N/A'}</td>
                </tr>
            `).join('');
        }

        async function chargerDashboard() {
            try {
                console.log('🔄 Chargement du dashboard...');
                
                // Charger les données
                const me = await API.getMe();
                console.log('✅ Me:', me);
                
                const dashboard = await API.getDashboardProf();
                console.log('✅ Dashboard:', dashboard);
                
                const matieres = dashboard.matieres || [];
                console.log('✅ Matières:', matieres.length);
                
                if (matieres.length === 0) {
                    console.warn('⚠️ Aucune matière trouvée');
                    return;
                }
                
                // Récupérer les filières de toutes les matières
                const filieresIds = [...new Set(matieres.map(m => m.filiere))];
                console.log('✅ Filières:', filieresIds);
                
                // Charger tous les étudiants des filières
                const promesses = filieresIds.map(filiereId => API.getEtudiants({ filiere: filiereId }));
                const resultats = await Promise.all(promesses);
                console.log('✅ Résultats étudiants:', resultats);
                
                // Fusionner et dédupliquer les étudiants
                const etudiantsMap = new Map();
                resultats.flat().forEach(e => {
                    if (!etudiantsMap.has(e.id)) {
                        etudiantsMap.set(e.id, e);
                    }
                });
                const totalEtudiants = etudiantsMap.size;
                console.log('✅ Total étudiants:', totalEtudiants);
                
                // Charger toutes les notes de l'enseignant
                const toutesLesNotes = [];
                for (const matiere of matieres) {
                    try {
                        const notes = await API.getNotes({ matiere: matiere.id });
                        toutesLesNotes.push(...notes);
                    } catch (err) {
                        console.warn(`⚠️ Erreur chargement notes matière ${matiere.id}:`, err.message);
                        // Continuer avec les autres matières
                    }
                }
                console.log('✅ Total notes:', toutesLesNotes.length);
                
                // Compter les notes saisies (au moins CC ou Examen)
                const notesSaisies = toutesLesNotes.filter(n => 
                    n.note_cc !== null || n.note_examen !== null
                ).length;
                console.log('✅ Notes saisies:', notesSaisies);
                
                // Charger l'emploi du temps
                const emplois = await API.getEmploisDuTemps();
                const mesEmplois = emplois.filter(e => matieres.some(m => m.id === e.matiere));
                const totalCours = mesEmplois.length;
                console.log('✅ Total cours:', totalCours);
                
                // Mettre à jour les statistiques
                const statMatieres = document.getElementById('statMatieres');
                const statEtudiants = document.getElementById('statEtudiants');
                const statNotes = document.getElementById('statNotes');
                const statCours = document.getElementById('statCours');
                
                if (statMatieres) statMatieres.textContent = matieres.length;
                if (statEtudiants) statEtudiants.textContent = totalEtudiants;
                if (statNotes) statNotes.textContent = notesSaisies;
                if (statCours) statCours.textContent = totalCours;
                
                console.log('✅ Dashboard chargé avec succès:', {
                    matieres: matieres.length,
                    etudiants: totalEtudiants,
                    notes: notesSaisies,
                    cours: totalCours
                });
                
            } catch (err) {
                console.error('❌ Erreur chargement dashboard:', err);
                showToast('Erreur de chargement du dashboard', 'danger');
            }
        }

        let matiereSelectionneeProfProf = null;
        let etudiantsMatiere = [];
        let evaluationsMatiere = [];
        let evaluationEnCours = null;
        let notesEvalEnCours = {};

        async function chargerMatieresNotes() {
            // Cette fonction n'est plus utilisée - remplacée par la nouvelle Poppinsface de saisie
            console.log('chargerMatieresNotes: fonction obsolète, ignorée');
        }

        async function chargerEtudiantsMatiere() {
            const selectMatiere = document.getElementById('selectMatiereNotes');
            const matiereId = selectMatiere.value;
            
            if (!matiereId) {
                document.getElementById('infoMatiere').style.display = 'none';
                document.getElementById('tbodyNotes').innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align:center;padding:60px;color:rgba(255,255,255,0.5)">
                            <div style="font-size:48px;margin-bottom:16px">📝</div>
                            <div style="font-size:16px;font-weight:600;margin-bottom:8px">Sélectionnez une matière</div>
                            <div style="font-size:14px">Choisissez une matière ci-dessus pour commencer la saisie des notes</div>
                        </td>
                    </tr>`;
                return;
            }

            try {
                // Récupérer les infos de la matière
                const selectedOption = selectMatiere.options[selectMatiere.selectedIndex];
                const matiereNom = selectedOption.getAttribute('data-nom');
                const matiereCoef = selectedOption.getAttribute('data-coef');
                
                matiereSelectionneeProf = {
                    id: matiereId,
                    nom: matiereNom,
                    coefficient: matiereCoef
                };

                // Récupérer la matière complète pour avoir la filière
                const matieres = await API.getMatieres();
                const matiere = matieres.find(m => m.id == matiereId);
                
                if (!matiere) {
                    showToast('Matière non trouvée', 'danger');
                    return;
                }

                // Récupérer tous les étudiants de la filière
                const etudiants = await API.getEtudiants({ filiere: matiere.filiere });
                etudiantsMatiere = etudiants;

                // Récupérer les notes existantes
                const notes = await API.getNotes({ matiere: matiereId });
                
                // Créer un map des notes par étudiant
                const notesMap = {};
                notes.forEach(n => {
                    notesMap[n.etudiant] = n;
                });

                // Afficher les infos
                document.getElementById('infoMatiere').style.display = 'block';
                document.getElementById('infoMatiereNom').textContent = matiereNom;
                document.getElementById('infoMatiereCoef').textContent = matiereCoef;
                document.getElementById('infoMatiereEtudiants').textContent = etudiants.length;
                
                const notesSaisies = notes.filter(n => n.note_cc !== null || n.note_examen !== null).length;
                document.getElementById('infoMatiereNotesSaisies').textContent = notesSaisies;

                // Afficher le tableau
                const tbody = document.getElementById('tbodyNotes');
                if (etudiants.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:40px;color:rgba(255,255,255,0.5)">Aucun étudiant dans cette filière</td></tr>';
                    return;
                }

                tbody.innerHTML = etudiants.map((e, index) => {
                    const note = notesMap[e.id];
                    const noteCC = note && note.note_cc !== undefined ? note.note_cc : '';
                    const noteExamen = note && note.note_examen !== undefined ? note.note_examen : '';
                    const moyenne = calculerMoyenne(noteCC, noteExamen);
                    const noteId = note && note.id ? note.id : null;

                    return `
                        <tr data-etudiant-id="${e.id}" data-note-id="${noteId || ''}">
                            <td style="text-align:center;color:rgba(255,255,255,0.5)">${index + 1}</td>
                            <td style="font-weight:600">${e.matricule}</td>
                            <td>${e.prenom} ${e.nom}</td>
                            <td><span class="badge-ultra primary">${e.niveau}</span></td>
                            <td>
                                <input type="number" 
                                    class="form-input-ultra" 
                                    style="padding:8px;text-align:center;background:rgba(255,255,255,0.05)"
                                    min="0" 
                                    max="20" 
                                    step="0.25"
                                    value="${noteCC}"
                                    placeholder="0.00"
                                    onchange="updateNote(${e.id}, 'cc', this.value)"
                                    onblur="sauvegarderNote(${e.id})">
                            </td>
                            <td>
                                <input type="number" 
                                    class="form-input-ultra" 
                                    style="padding:8px;text-align:center;background:rgba(255,255,255,0.05)"
                                    min="0" 
                                    max="20" 
                                    step="0.25"
                                    value="${noteExamen}"
                                    placeholder="0.00"
                                    onchange="updateNote(${e.id}, 'examen', this.value)"
                                    onblur="sauvegarderNote(${e.id})">
                            </td>
                            <td style="text-align:center">
                                <span style="font-weight:700;font-size:16px;color:${moyenne >= 10 ? '#10b981' : moyenne > 0 ? '#ef4444' : 'rgba(255,255,255,0.3)'}" id="moyenne-${e.id}">
                                    ${moyenne > 0 ? moyenne.toFixed(2) : '-'}
                                </span>
                            </td>
                            <td style="text-align:center">
                                <span class="badge-ultra ${moyenne >= 10 ? 'success' : moyenne > 0 ? 'danger' : ''}" id="statut-${e.id}">
                                    ${moyenne >= 10 ? 'Validé' : moyenne > 0 ? 'Ajourné' : '-'}
                                </span>
                            </td>
                            <td style="text-align:center">
                                <button class="btn-ultra btn-ghost-ultra btn-sm-ultra" onclick="supprimerNote(${e.id}, ${noteId})" title="Supprimer" ${!noteId ? 'disabled' : ''}>
                                    🗑️
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');

                // Activer le bouton publier si des notes existent
                document.getElementById('btnPublier').disabled = notesSaisies === 0;

            } catch (err) {
                console.error('Erreur:', err);
                showToast('Erreur de chargement: ' + err.message, 'danger');
            }
        }

        function calculerMoyenne(noteCC, noteExamen) {
            const cc = parseFloat(noteCC) || 0;
            const examen = parseFloat(noteExamen) || 0;
            
            if (cc === 0 && examen === 0) return 0;
            
            return cc * 0.4 + examen * 0.6;
        }

        function updateNote(etudiantId, type, valeur) {
            if (!notesEnCours[etudiantId]) {
                notesEnCours[etudiantId] = { note_cc: null, note_examen: null };
            }
            
            if (type === 'cc') {
                notesEnCours[etudiantId].note_cc = valeur ? parseFloat(valeur) : null;
            } else {
                notesEnCours[etudiantId].note_examen = valeur ? parseFloat(valeur) : null;
            }

            // Mettre à jour l'affichage de la moyenne
            const row = document.querySelector(`tr[data-etudiant-id="${etudiantId}"]`);
            const inputCC = row.querySelector('input[type="number"]:nth-of-type(1)');
            const inputExamen = row.querySelector('input[type="number"]:nth-of-type(2)');
            
            const moyenne = calculerMoyenne(inputCC.value, inputExamen.value);
            
            const moyenneSpan = document.getElementById(`moyenne-${etudiantId}`);
            const statutSpan = document.getElementById(`statut-${etudiantId}`);
            
            if (moyenne > 0) {
                moyenneSpan.textContent = moyenne.toFixed(2);
                moyenneSpan.style.color = moyenne >= 10 ? '#10b981' : '#ef4444';
                
                statutSpan.textContent = moyenne >= 10 ? 'Validé' : 'Ajourné';
                statutSpan.className = `badge-ultra ${moyenne >= 10 ? 'success' : 'danger'}`;
            } else {
                moyenneSpan.textContent = '-';
                moyenneSpan.style.color = 'rgba(255,255,255,0.3)';
                statutSpan.textContent = '-';
                statutSpan.className = 'badge-ultra';
            }
        }

        async function sauvegarderNote(etudiantId) {
            if (!matiereSelectionneeProf) {
                showToast('Veuillez sélectionner une matière', 'warning');
                return;
            }

            const noteData = notesEnCours[etudiantId];
            if (!noteData) return;

            try {
                const annees = await API.getAnnees();
                const anneeActive = annees.find(a => a.active) || annees[0];

                const row = document.querySelector(`tr[data-etudiant-id="${etudiantId}"]`);
                const noteId = row.getAttribute('data-note-id');

                const data = {
                    etudiant: etudiantId,
                    matiere: matiereSelectionneeProf.id,
                    annee_academique: anneeActive.id,
                    note_cc: noteData.note_cc,
                    note_examen: noteData.note_examen,
                    publie: false
                };

                if (noteId) {
                    // Mise à jour
                    await API.updateNote(noteId, data);
                } else {
                    // Création
                    const newNote = await API.createNote(data);
                    row.setAttribute('data-note-id', newNote.id);
                }

                // Petit feedback visuel
                row.style.background = 'rgba(16,185,129,0.1)';
                setTimeout(() => {
                    row.style.background = '';
                }, 500);

                delete notesEnCours[etudiantId];

            } catch (err) {
                console.error('Erreur:', err);
                showToast('Erreur de sauvegarde: ' + err.message, 'danger');
            }
        }

        async function sauvegarderToutesLesNotes() {
            if (Object.keys(notesEnCours).length === 0) {
                showToast('Aucune modification à sauvegarder', 'info');
                return;
            }

            const etudiantIds = Object.keys(notesEnCours);
            let saved = 0;

            for (const etudiantId of etudiantIds) {
                await sauvegarderNote(parseInt(etudiantId));
                saved++;
            }

            showToast(`${saved} note(s) sauvegardée(s) avec succès`, 'success');
            chargerEtudiantsMatiere(); // Recharger pour mettre à jour les stats
        }

        async function publierNotes() {
            if (!matiereSelectionneeProf) {
                showToast('Veuillez sélectionner une matière', 'warning');
                return;
            }

            if (!confirm('Êtes-vous sûr de vouloir publier les notes ? Les étudiants pourront les consulter.')) {
                return;
            }

            try {
                const annees = await API.getAnnees();
                const anneeActive = annees.find(a => a.active) || annees[0];

                await API.publierNotes(matiereSelectionneeProf.id, anneeActive.id);
                showToast('Notes publiées avec succès !', 'success');
                chargerEtudiantsMatiere();
            } catch (err) {
                console.error('Erreur:', err);
                showToast('Erreur de publication: ' + err.message, 'danger');
            }
        }

        let notesEnCours = {};
        // matiereSelectionneeProf, etudiantsMatiere, evaluationsMatiere, evaluationEnCours, notesEvalEnCours déjà déclarés plus haut

        async function chargerEvaluationsMatiere() {
            const selectMatiere = document.getElementById('selectMatiereNotes');
            const matiereId = selectMatiere.value;
            
            if (!matiereId) {
                document.getElementById('contenuEvaluations').style.display = 'none';
                return;
            }

            try {
                // Récupérer les infos de la matière
                const selectedOption = selectMatiere.options[selectMatiere.selectedIndex];
                const matiereNom = selectedOption.getAttribute('data-nom');
                const matiereCoef = selectedOption.getAttribute('data-coef');
                const filiereId = selectedOption.getAttribute('data-filiere');
                
                matiereSelectionneeProf = {
                    id: matiereId,
                    nom: matiereNom,
                    coefficient: matiereCoef,
                    filiere: filiereId
                };

                // Récupérer les étudiants de la filière
                const etudiants = await API.getEtudiants({ filiere: filiereId });
                etudiantsMatiere = etudiants;

                // Récupérer l'année académique active
                const annees = await API.getAnnees();
                const anneeActive = annees.find(a => a.active) || annees[0];

                // Récupérer les évaluations de cette matière
                const evaluations = await API.getEvaluations({ 
                    matiere: matiereId,
                    annee_academique: anneeActive.id
                });
                evaluationsMatiere = evaluations;

                // Récupérer toutes les notes d'évaluations
                const notesEvals = await API.getNotesEvaluations({ matiere: matiereId });

                // Compter les notes saisies
                const notesSaisies = notesEvals.filter(n => n.note !== null && !n.absent).length;

                // Afficher le contenu
                document.getElementById('contenuEvaluations').style.display = 'block';
                document.getElementById('statNbEvaluations').textContent = evaluations.length;
                document.getElementById('statNbEtudiants').textContent = etudiants.length;
                document.getElementById('statNotesSaisies').textContent = notesSaisies;

                // Afficher les évaluations
                afficherEvaluations();

            } catch (err) {
                console.error('Erreur:', err);
                showToast('Erreur de chargement: ' + err.message, 'danger');
            }
        }

        function afficherEvaluations() {
            const container = document.getElementById('listeEvaluations');
            
            if (evaluationsMatiere.length === 0) {
                container.innerHTML = '<div style="text-align:center;padding:40px;color:rgba(255,255,255,0.5)">Aucune évaluation. Créez-en une pour commencer.</div>';
                return;
            }

            const typeIcons = {
                devoir: '📝',
                Poppinsrogation: '📄',
                tp: '🔬',
                projet: '💼',
                examen: '📋',
                oral: '🎤'
            };

            const categorieColors = {
                cc: { bg: 'rgba(99,102,241,0.1)', border: 'rgba(99,102,241,0.3)', text: '#6366f1' },
                examen: { bg: 'rgba(239,68,68,0.1)', border: 'rgba(239,68,68,0.3)', text: '#ef4444' }
            };

            container.innerHTML = evaluationsMatiere.map(eval => {
                const color = categorieColors[eval.categorie];
                return `
                    <div style="background:${color.bg};border:1px solid ${color.border};border-radius:12px;padding:20px;display:grid;grid-template-columns:1fr auto;gap:16px;align-items:start">
                        <div>
                            <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
                                <span style="font-size:24px">${typeIcons[eval.type_evaluation]}</span>
                                <div>
                                    <div style="font-size:16px;font-weight:600;color:#fff">${eval.titre}</div>
                                    <div style="font-size:13px;color:rgba(255,255,255,0.6);margin-top:2px">
                                        ${eval.type_evaluation.charAt(0).toUpperCase() + eval.type_evaluation.slice(1)} · 
                                        <span style="color:${color.text};font-weight:600">${eval.categorie.toUpperCase()}</span> · 
                                        Coef. ${eval.coefficient} · 
                                        Note sur ${eval.note_sur} · 
                                        ${formatDate(eval.date_evaluation)}
                                    </div>
                                </div>
                            </div>
                            ${eval.description ? `<div style="font-size:13px;color:rgba(255,255,255,0.6);margin-top:8px">${eval.description}</div>` : ''}
                        </div>
                        <div style="display:flex;gap:8px">
                            <button class="btn-ultra btn-primary-ultra-ultra btn-sm-ultra" onclick="ouvrirSaisieNotes(${eval.id})" style="background: linear-gradient(135deg, #10b981, #059669)">
                                📝 Saisir notes
                            </button>
                            <button class="btn-ultra btn-ghost-ultra btn-sm-ultra" onclick="modifierEvaluation(${eval.id})" title="Modifier">
                                ✏️
                            </button>
                            <button class="btn-ultra btn-ghost-ultra btn-sm-ultra" onclick="supprimerEvaluation(${eval.id})" title="Supprimer">
                                🗑️
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function ouvrirModalEvaluation() {
            document.getElementById('modalEvaluationTitle').textContent = '📝 Nouvelle évaluation';
            document.getElementById('editEvalId').value = '';
            document.getElementById('formEvaluation').reset();
            
            // Date par défaut: aujourd'hui
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('editEvalDate').value = today;
            
            openModal('modalEvaluation');
        }

        async function modifierEvaluation(evalId) {
            try {
                const evaluation = await API.getEvaluation(evalId);
                
                document.getElementById('modalEvaluationTitle').textContent = '✏️ Modifier l\'évaluation';
                document.getElementById('editEvalId').value = evaluation.id;
                document.getElementById('editEvalTitre').value = evaluation.titre;
                document.getElementById('editEvalType').value = evaluation.type_evaluation;
                document.getElementById('editEvalCategorie').value = evaluation.categorie;
                document.getElementById('editEvalCoef').value = evaluation.coefficient;
                document.getElementById('editEvalNoteSur').value = evaluation.note_sur;
                document.getElementById('editEvalDate').value = evaluation.date_evaluation;
                document.getElementById('editEvalDescription').value = evaluation.description || '';
                
                openModal('modalEvaluation');
            } catch (err) {
                console.error('Erreur:', err);
                showToast('Erreur de chargement: ' + err.message, 'danger');
            }
        }

        async function sauvegarderEvaluation(event) {
            event.preventDefault();
            
            if (!matiereSelectionneeProf) {
                showToast('Veuillez sélectionner une matière', 'warning');
                return;
            }

            try {
                const form = event.target;
                const evalId = document.getElementById('editEvalId').value;
                
                // Récupérer l'année académique active
                const annees = await API.getAnnees();
                const anneeActive = annees.find(a => a.active) || annees[0];

                const data = {
                    matiere: matiereSelectionneeProf.id,
                    annee_academique: anneeActive.id,
                    titre: form.titre.value,
                    type_evaluation: form.type_evaluation.value,
                    categorie: form.categorie.value,
                    coefficient: parseInt(form.coefficient.value),
                    note_sur: parseFloat(form.note_sur.value),
                    date_evaluation: form.date_evaluation.value,
                    description: form.description.value
                };

                if (evalId) {
                    // Modification
                    await API.updateEvaluation(evalId, data);
                    showToast('Évaluation modifiée avec succès', 'success');
                } else {
                    // Création
                    const newEval = await API.createEvaluation(data);
                    showToast('Évaluation créée avec succès', 'success');
                    
                    // Générer les notes vides pour tous les étudiants
                    await API.genererNotesEvaluation(newEval.id);
                }

                closeModal('modalEvaluation');
                chargerEvaluationsMatiere();

            } catch (err) {
                console.error('Erreur:', err);
                showToast('Erreur: ' + err.message, 'danger');
            }
        }

        async function supprimerEvaluation(evalId) {
            if (!confirm('Êtes-vous sûr de vouloir supprimer cette évaluation ? Toutes les notes associées seront également supprimées.')) {
                return;
            }

            try {
                await API.deleteEvaluation(evalId);
                showToast('Évaluation supprimée', 'success');
                chargerEvaluationsMatiere();
            } catch (err) {
                console.error('Erreur:', err);
                showToast('Erreur: ' + err.message, 'danger');
            }
        }

        async function ouvrirSaisieNotes(evalId) {
            try {
                // Récupérer l'évaluation
                const evaluation = await API.getEvaluation(evalId);
                evaluationEnCours = evaluation;

                // Récupérer les notes de cette évaluation
                const notes = await API.getNotesEvaluations({ evaluation: evalId });
                
                // Créer un map des notes par étudiant
                const notesMap = {};
                notes.forEach(n => {
                    notesMap[n.etudiant] = n;
                });

                // Afficher les infos de l'évaluation
                const typeIcons = {
                    devoir: '📝',
                    Poppinsrogation: '📄',
                    tp: '🔬',
                    projet: '💼',
                    examen: '📋',
                    oral: '🎤'
                };

                document.getElementById('infoEvaluation').innerHTML = `
                    <div style="display:flex;align-items:center;gap:12px">
                        <span style="font-size:28px">${typeIcons[evaluation.type_evaluation]}</span>
                        <div style="flex:1">
                            <div style="font-size:16px;font-weight:600;color:#fff">${evaluation.titre}</div>
                            <div style="font-size:13px;color:rgba(255,255,255,0.7);margin-top:4px">
                                ${evaluation.type_evaluation.charAt(0).toUpperCase() + evaluation.type_evaluation.slice(1)} · 
                                ${evaluation.categorie.toUpperCase()} · 
                                Coef. ${evaluation.coefficient} · 
                                Note sur ${evaluation.note_sur} · 
                                ${formatDate(evaluation.date_evaluation)}
                            </div>
                        </div>
                    </div>
                `;

                // Afficher le tableau des étudiants
                const tbody = document.getElementById('tbodyNotesEval');
                tbody.innerHTML = etudiantsMatiere.map((e, index) => {
                    const note = notesMap[e.id];
                    const noteValue = note && note.note !== undefined && note.note !== null ? note.note : '';
                    const absent = note && note.absent !== undefined ? note.absent : false;
                    const commentaire = note && note.commentaire !== undefined ? note.commentaire : '';
                    const noteId = note && note.id ? note.id : null;

                    return `
                        <tr data-etudiant-id="${e.id}" data-note-id="${noteId || ''}">
                            <td style="text-align:center;color:rgba(255,255,255,0.5)">${index + 1}</td>
                            <td style="font-weight:600">${e.matricule}</td>
                            <td>${e.prenom} ${e.nom}</td>
                            <td>
                                <input type="number" 
                                    class="form-input-ultra" 
                                    style="padding:8px;text-align:center;background:rgba(255,255,255,0.05)"
                                    min="0" 
                                    max="${evaluation.note_sur}" 
                                    step="0.25"
                                    value="${noteValue}"
                                    placeholder="0.00"
                                    ${absent ? 'disabled' : ''}
                                    onchange="updateNoteEval(${e.id}, this.value)">
                            </td>
                            <td style="text-align:center">
                                <input type="checkbox" 
                                    ${absent ? 'checked' : ''}
                                    onchange="toggleAbsent(${e.id}, this.checked)"
                                    style="width:20px;height:20px;cursor:poPoppins">
                            </td>
                            <td>
                                <input type="text" 
                                    class="form-input-ultra" 
                                    style="padding:8px;font-size:12px;background:rgba(255,255,255,0.05)"
                                    value="${commentaire}"
                                    placeholder="Commentaire..."
                                    onchange="updateCommentaire(${e.id}, this.value)">
                            </td>
                        </tr>
                    `;
                }).join('');

                // Mettre à jour le compteur
                const notesSaisies = notes.filter(n => n.note !== null || n.absent).length;
                document.getElementById('progressNotes').textContent = `${notesSaisies}/${etudiantsMatiere.length} notes saisies`;

                openModal('modalSaisieNotes');

            } catch (err) {
                console.error('Erreur:', err);
                showToast('Erreur: ' + err.message, 'danger');
            }
        }

        function updateNoteEval(etudiantId, valeur) {
            if (!notesEvalEnCours[etudiantId]) {
                notesEvalEnCours[etudiantId] = {};
            }
            notesEvalEnCours[etudiantId].note = valeur ? parseFloat(valeur) : null;
        }

        function toggleAbsent(etudiantId, absent) {
            if (!notesEvalEnCours[etudiantId]) {
                notesEvalEnCours[etudiantId] = {};
            }
            notesEvalEnCours[etudiantId].absent = absent;

            // Désactiver/activer le champ de note
            const row = document.querySelector(`#tbodyNotesEval tr[data-etudiant-id="${etudiantId}"]`);
            const inputNote = row.querySelector('input[type="number"]');
            inputNote.disabled = absent;
            if (absent) {
                inputNote.value = '';
                notesEvalEnCours[etudiantId].note = null;
            }
        }

        function updateCommentaire(etudiantId, commentaire) {
            if (!notesEvalEnCours[etudiantId]) {
                notesEvalEnCours[etudiantId] = {};
            }
            notesEvalEnCours[etudiantId].commentaire = commentaire;
        }

        async function sauvegarderToutesNotesEval() {
            if (!evaluationEnCours) {
                showToast('Aucune évaluation sélectionnée', 'warning');
                return;
            }

            try {
                let saved = 0;
                const rows = document.querySelectorAll('#tbodyNotesEval tr');

                for (const row of rows) {
                    const etudiantId = parseInt(row.getAttribute('data-etudiant-id'));
                    const noteId = row.getAttribute('data-note-id');
                    
                    const inputNote = row.querySelector('input[type="number"]');
                    const inputAbsent = row.querySelector('input[type="checkbox"]');
                    const inputCommentaire = row.querySelector('input[type="text"]');

                    const data = {
                        evaluation: evaluationEnCours.id,
                        etudiant: etudiantId,
                        note: inputNote.value ? parseFloat(inputNote.value) : null,
                        absent: inputAbsent.checked,
                        commentaire: inputCommentaire.value
                    };

                    if (noteId) {
                        // Mise à jour
                        await API.updateNoteEvaluation(noteId, data);
                    } else {
                        // Création
                        const newNote = await API.createNoteEvaluation(data);
                        row.setAttribute('data-note-id', newNote.id);
                    }
                    saved++;
                }

                showToast(`${saved} note(s) sauvegardée(s) avec succès`, 'success');
                notesEvalEnCours = {};
                
                // Mettre à jour le compteur
                const notes = await API.getNotesEvaluations({ evaluation: evaluationEnCours.id });
                const notesSaisies = notes.filter(n => n.note !== null || n.absent).length;
                document.getElementById('progressNotes').textContent = `${notesSaisies}/${etudiantsMatiere.length} notes saisies`;
                
                // Recharger les stats
                chargerEvaluationsMatiere();

            } catch (err) {
                console.error('Erreur:', err);
                showToast('Erreur de sauvegarde: ' + err.message, 'danger');
            }
        }

        // ===== NOUVELLE SECTION: SAISIE DES NOTES SIMPLIFIÉE =====
        let notesEnCoursModification = {}; // Stocke les notes en cours de modification
        let matiereSelectionnee = null;
        let anneeSelectionnee = null;
        let filiereSelectionnee = null;

        async function chargerMatieresFiliereEtAnnees() {
            const filiereId = document.getElementById('selectFiliereSaisie').value;
            
            if (!filiereId) {
                document.getElementById('selectMatiereSaisie').innerHTML = '<option value="">Sélectionner une matière...</option>';
                document.getElementById('contenuSaisieNotes').style.display = 'none';
                return;
            }

            filiereSelectionnee = parseInt(filiereId);

            try {
                // Charger les matières de cette filière enseignées par le prof
                const dashboard = await API.getDashboardProf();
                const matieres = dashboard.matieres.filter(m => m.filiere === filiereSelectionnee);
                
                const selectMatiere = document.getElementById('selectMatiereSaisie');
                selectMatiere.innerHTML = '<option value="">Sélectionner une matière...</option>';
                matieres.forEach(m => {
                    selectMatiere.innerHTML += `<option value="${m.id}">${m.nom} - ${m.code}</option>`;
                });

                // Charger les années académiques
                const annees = await API.getAnnees();
                const selectAnnee = document.getElementById('selectAnneeSaisie');
                selectAnnee.innerHTML = '<option value="">Sélectionner une année...</option>';
                annees.forEach(a => {
                    const selected = a.active ? 'selected' : '';
                    selectAnnee.innerHTML += `<option value="${a.id}" ${selected}>${a.libelle}</option>`;
                });

            } catch (err) {
                console.error('Erreur:', err);
                showToast('Erreur lors du chargement', 'danger');
            }
        }

        async function chargerEtudiantsMatiere() {
            const matiereId = document.getElementById('selectMatiereSaisie').value;
            const anneeId = document.getElementById('selectAnneeSaisie').value;

            if (!matiereId || !anneeId) {
                document.getElementById('contenuSaisieNotes').style.display = 'none';
                return;
            }

            matiereSelectionnee = parseInt(matiereId);
            anneeSelectionnee = parseInt(anneeId);

            try {
                // Charger les étudiants de la filière
                const etudiants = await API.getEtudiants({ filiere: filiereSelectionnee });
                
                // Charger les notes existantes
                const notes = await API.getNotes({ 
                    matiere: matiereSelectionnee,
                    annee_academique: anneeSelectionnee
                });

                // Créer un map des notes par étudiant
                const notesMap = {};
                notes.forEach(n => {
                    notesMap[n.etudiant] = n;
                });

                // Afficher le tableau
                const tbody = document.getElementById('tbodySaisieNotes');
                tbody.innerHTML = etudiants.map((e, index) => {
                    const note = notesMap[e.id];
                    const noteCC = note && note.note_cc !== null && note.note_cc !== undefined ? note.note_cc : '';
                    const noteExamen = note && note.note_examen !== null && note.note_examen !== undefined ? note.note_examen : '';
                    const moyenne = note && note.moyenne !== null && note.moyenne !== undefined ? note.moyenne.toFixed(2) : '-';
                    const statut = note && note.publie ? 'Publiée' : 'Brouillon';
                    const statutClass = note && note.publie ? 'success' : 'warning';
                    const noteId = note && note.id ? note.id : null;

                    return `
                        <tr data-etudiant-id="${e.id}" data-note-id="${noteId || ''}">
                            <td style="text-align:center;color:rgba(255,255,255,0.5)">${index + 1}</td>
                            <td style="font-weight:600">${e.matricule}</td>
                            <td>${e.nom} ${e.prenom}</td>
                            <td>
                                <input type="number" 
                                    class="form-input-ultra" 
                                    style="width:100%;padding:8px;text-align:center" 
                                    min="0" 
                                    max="20" 
                                    step="0.5"
                                    value="${noteCC}"
                                    onchange="marquerNoteModifiee(${e.id}, 'cc', this.value)"
                                    placeholder="0.00">
                            </td>
                            <td>
                                <input type="number" 
                                    class="form-input-ultra" 
                                    style="width:100%;padding:8px;text-align:center" 
                                    min="0" 
                                    max="20" 
                                    step="0.5"
                                    value="${noteExamen}"
                                    onchange="marquerNoteModifiee(${e.id}, 'examen', this.value)"
                                    placeholder="0.00">
                            </td>
                            <td style="text-align:center;font-weight:700;font-size:16px;color:#10b981">${moyenne}</td>
                            <td style="text-align:center">
                                <span class="badge-ultra ${statutClass}">${statut}</span>
                            </td>
                        </tr>
                    `;
                }).join('');

                // Mettre à jour les statistiques
                const notesSaisies = notes.filter(n => n.note_cc !== null || n.note_examen !== null).length;
                const notesPubliees = notes.filter(n => n.publie).length;
                
                document.getElementById('statNbEtudiantsSaisie').textContent = etudiants.length;
                document.getElementById('statNotesSaisiesSaisie').textContent = notesSaisies;
                document.getElementById('statNotesPublieesSaisie').textContent = notesPubliees;

                // Afficher le contenu
                document.getElementById('contenuSaisieNotes').style.display = 'block';

                // Réinitialiser les notes en cours de modification
                notesEnCoursModification = {};

            } catch (err) {
                console.error('Erreur:', err);
                showToast('Erreur lors du chargement des étudiants: ' + err.message, 'danger');
            }
        }

        function marquerNoteModifiee(etudiantId, type, valeur) {
            if (!notesEnCoursModification[etudiantId]) {
                notesEnCoursModification[etudiantId] = {};
            }
            notesEnCoursModification[etudiantId][type] = valeur === '' ? null : parseFloat(valeur);
            
            // Calculer et afficher la moyenne en temps réel
            const row = document.querySelector(`tr[data-etudiant-id="${etudiantId}"]`);
            const inputCC = row.querySelector('input[type="number"]:nth-of-type(1)');
            const inputExamen = row.querySelector('input[type="number"]:nth-of-type(2)');
            const cellMoyenne = row.querySelector('td:nth-child(6)');
            
            const cc = inputCC.value === '' ? null : parseFloat(inputCC.value);
            const examen = inputExamen.value === '' ? null : parseFloat(inputExamen.value);
            
            if (cc !== null && examen !== null) {
                const moyenne = ((cc + examen) / 2).toFixed(2);
                cellMoyenne.textContent = moyenne;
                cellMoyenne.style.color = moyenne >= 10 ? '#10b981' : '#ef4444';
            } else if (cc !== null) {
                cellMoyenne.textContent = cc.toFixed(2);
            } else if (examen !== null) {
                cellMoyenne.textContent = examen.toFixed(2);
            } else {
                cellMoyenne.textContent = '-';
            }
        }

        async function sauvegarderToutesLesNotes() {
            if (Object.keys(notesEnCoursModification).length === 0) {
                showToast('Aucune modification à sauvegarder', 'info');
                return;
            }

            try {
                let saved = 0;
                
                for (const etudiantId in notesEnCoursModification) {
                    const row = document.querySelector(`tr[data-etudiant-id="${etudiantId}"]`);
                    const noteId = row.getAttribute('data-note-id');
                    
                    const noteCC = notesEnCoursModification[etudiantId].cc;
                    const noteExamen = notesEnCoursModification[etudiantId].examen;
                    
                    // Calculer la moyenne
                    let moyenne = null;
                    if (noteCC !== null && noteCC !== undefined && noteExamen !== null && noteExamen !== undefined) {
                        moyenne = (noteCC + noteExamen) / 2;
                    } else if (noteCC !== null && noteCC !== undefined) {
                        moyenne = noteCC;
                    } else if (noteExamen !== null && noteExamen !== undefined) {
                        moyenne = noteExamen;
                    }
                    
                    const data = {
                        etudiant: parseInt(etudiantId),
                        matiere: matiereSelectionnee,
                        annee_academique: anneeSelectionnee,
                        note_cc: noteCC,
                        note_examen: noteExamen,
                        moyenne: moyenne,
                        publie: false
                    };

                    if (noteId) {
                        await API.updateNote(noteId, data);
                    } else {
                        const newNote = await API.createNote(data);
                        row.setAttribute('data-note-id', newNote.id);
                    }
                    
                    saved++;
                }

                showToast(`${saved} note(s) sauvegardée(s) avec succès`, 'success');
                notesEnCoursModification = {};
                
                // Recharger pour mettre à jour les statistiques
                await chargerEtudiantsMatiere();

            } catch (err) {
                console.error('Erreur:', err);
                showToast('Erreur lors de la sauvegarde: ' + err.message, 'danger');
            }
        }

        async function publierNotesMatiere() {
            if (!matiereSelectionnee || !anneeSelectionnee) {
                showToast('Veuillez sélectionner une matière et une année', 'warning');
                return;
            }

            if (!confirm('Êtes-vous sûr de vouloir publier les notes ? Les étudiants recevront une notification et pourront les consulter.')) {
                return;
            }

            try {
                const response = await API.post('/notes/publier/', {
                    matiere_id: matiereSelectionnee,
                    annee_academique_id: anneeSelectionnee
                });

                showToast(response.detail || 'Notes publiées avec succès', 'success');
                
                // Recharger pour mettre à jour les statuts
                await chargerEtudiantsMatiere();

            } catch (err) {
                console.error('Erreur:', err);
                showToast('Erreur lors de la publication: ' + err.message, 'danger');
            }
        }

        // ===== FIN NOUVELLE SECTION =====

        document.addEventListener('DOMContentLoaded', function() {
            const user = requireAuth(['professeur', 'enseignant']);
            if (user) {
                chargerMatieres();
                chargerSupports();
                chargerDashboard();
                chargerMatieresNotes();
                chargerFilieresSaisie();
            }
        });

        // Charger les filières pour la saisie des notes
        async function chargerFilieresSaisie() {
            try {
                const filieres = await API.getFilieres();
                const select = document.getElementById('selectFiliereSaisie');
                select.innerHTML = '<option value="">Sélectionner une filière...</option>';
                filieres.forEach(f => {
                    select.innerHTML += `<option value="${f.id}">${f.nom} - ${f.code}</option>`;
                });
            } catch (err) {
                console.error('Erreur chargement filières:', err);
            }
        }

        // ===== GESTION DES PRÉSENCES =====
        
        let matiereSelectionneePresence = null;
        let etudiantsPresence = [];
        let presencesEnCours = {}; // {etudiantId: {present, justifie, observation}}

        // Charger les filières pour les présences
        async function chargerFilieresPresence() {
            try {
                const filieres = await API.getFilieres();
                const select = document.getElementById('selectFilierePresence');
                select.innerHTML = '<option value="">Sélectionner une filière...</option>';
                filieres.forEach(f => {
                    select.innerHTML += `<option value="${f.id}">${f.nom} - ${f.code}</option>`;
                });
                
                // Définir la date d'aujourd'hui par défaut
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('inputDatePresence').value = today;
            } catch (err) {
                console.error('Erreur chargement filières:', err);
                showToast('Erreur lors du chargement des filières', 'error');
            }
        }

        // Charger les matières d'une filière pour les présences
        async function chargerMatieresPresence() {
            const filiereId = document.getElementById('selectFilierePresence').value;
            const selectMatiere = document.getElementById('selectMatierePresence');
            
            if (!filiereId) {
                selectMatiere.innerHTML = '<option value="">Sélectionner une matière...</option>';
                document.getElementById('contenuPresences').style.display = 'none';
                return;
            }

            try {
                const me = await API.getMe();
                const dashboard = await API.getDashboardProf();
                
                // Filtrer les matières de la filière sélectionnée
                const matieres = dashboard.matieres.filter(m => m.filiere === parseInt(filiereId));
                
                selectMatiere.innerHTML = '<option value="">Sélectionner une matière...</option>';
                matieres.forEach(m => {
                    selectMatiere.innerHTML += `<option value="${m.id}">${m.nom} (${m.code})</option>`;
                });
            } catch (err) {
                console.error('Erreur chargement matières:', err);
                showToast('Erreur lors du chargement des matières', 'error');
            }
        }

        // Charger les étudiants pour la feuille de présence
        async function chargerEtudiantsPresence() {
            const matiereId = document.getElementById('selectMatierePresence').value;
            const dateCours = document.getElementById('inputDatePresence').value;
            
            if (!matiereId || !dateCours) {
                document.getElementById('contenuPresences').style.display = 'none';
                return;
            }

            try {
                matiereSelectionneePresence = parseInt(matiereId);
                
                // Récupérer les notes pour avoir la liste des étudiants
                const notes = await API.getNotes({ matiere: matiereId });
                
                // Extraire les étudiants uniques
                const etudiantsMap = new Map();
                notes.forEach(note => {
                    if (!etudiantsMap.has(note.etudiant)) {
                        etudiantsMap.set(note.etudiant, {
                            id: note.etudiant,
                            matricule: note.etudiant_matricule || 'N/A',
                            nom: note.etudiant_nom || 'N/A'
                        });
                    }
                });
                
                etudiantsPresence = Array.from(etudiantsMap.values());
                
                // Charger les présences existantes pour cette date
                // TODO: Implémenter l'API pour récupérer les présences existantes
                // const presencesExistantes = await API.getPresences({ matiere: matiereId, date: dateCours });
                
                // Afficher le contenu
                document.getElementById('contenuPresences').style.display = 'block';
                afficherFeuillePresence();
                
            } catch (err) {
                console.error('Erreur chargement étudiants:', err);
                showToast('Erreur lors du chargement des étudiants', 'error');
            }
        }

        // Afficher la feuille de présence
        function afficherFeuillePresence() {
            const tbody = document.getElementById('tbodyPresences');
            
            if (etudiantsPresence.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align:center;padding:40px;color:rgba(255,255,255,0.5)">
                            Aucun étudiant trouvé pour cette matière
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = etudiantsPresence.map((e, index) => {
                const presence = presencesEnCours[e.id] || { present: false, justifie: false, observation: '' };
                
                return `
                    <tr data-etudiant-id="${e.id}">
                        <td style="text-align:center;color:rgba(255,255,255,0.5)">${index + 1}</td>
                        <td style="font-weight:600">${e.matricule}</td>
                        <td>${e.nom}</td>
                        <td style="text-align:center">
                            <label style="display:inline-flex;align-items:center;gap:8px;cursor:poPoppins">
                                <input type="checkbox" 
                                    ${presence.present ? 'checked' : ''}
                                    onchange="togglePresence(${e.id}, this.checked)"
                                    style="width:20px;height:20px;cursor:poPoppins">
                                <span style="font-size:13px">${presence.present ? '✅ Présent' : '❌ Absent'}</span>
                            </label>
                        </td>
                        <td style="text-align:center">
                            <input type="checkbox" 
                                ${presence.justifie ? 'checked' : ''}
                                ${presence.present ? 'disabled' : ''}
                                onchange="toggleJustifie(${e.id}, this.checked)"
                                style="width:20px;height:20px;cursor:poPoppins">
                        </td>
                        <td>
                            <input type="text" 
                                class="form-input-ultra" 
                                style="padding:8px;font-size:12px;background:rgba(255,255,255,0.05)"
                                value="${presence.observation}"
                                placeholder="Observation..."
                                onchange="updateObservation(${e.id}, this.value)">
                        </td>
                    </tr>
                `;
            }).join('');

            // Mettre à jour les statistiques
            updateStatistiquesPresence();
        }

        // Basculer la présence d'un étudiant
        function togglePresence(etudiantId, present) {
            if (!presencesEnCours[etudiantId]) {
                presencesEnCours[etudiantId] = { present: false, justifie: false, observation: '' };
            }
            presencesEnCours[etudiantId].present = present;
            
            // Si présent, décocher "justifié"
            if (present) {
                presencesEnCours[etudiantId].justifie = false;
            }
            
            afficherFeuillePresence();
        }

        // Basculer le justificatif d'absence
        function toggleJustifie(etudiantId, justifie) {
            if (!presencesEnCours[etudiantId]) {
                presencesEnCours[etudiantId] = { present: false, justifie: false, observation: '' };
            }
            presencesEnCours[etudiantId].justifie = justifie;
            updateStatistiquesPresence();
        }

        // Mettre à jour l'observation
        function updateObservation(etudiantId, observation) {
            if (!presencesEnCours[etudiantId]) {
                presencesEnCours[etudiantId] = { present: false, justifie: false, observation: '' };
            }
            presencesEnCours[etudiantId].observation = observation;
        }

        // Marquer tous les étudiants présents
        function marquerTousPresents() {
            etudiantsPresence.forEach(e => {
                presencesEnCours[e.id] = { present: true, justifie: false, observation: '' };
            });
            afficherFeuillePresence();
            showToast('Tous les étudiants marqués présents', 'success');
        }

        // Marquer tous les étudiants absents
        function marquerTousAbsents() {
            etudiantsPresence.forEach(e => {
                presencesEnCours[e.id] = { present: false, justifie: false, observation: '' };
            });
            afficherFeuillePresence();
            showToast('Tous les étudiants marqués absents', 'warning');
        }

        // Mettre à jour les statistiques de présence
        function updateStatistiquesPresence() {
            const total = etudiantsPresence.length;
            let presents = 0;
            let absents = 0;

            etudiantsPresence.forEach(e => {
                const presence = presencesEnCours[e.id];
                if (presence && presence.present) {
                    presents++;
                } else {
                    absents++;
                }
            });

            const tauxPresence = total > 0 ? Math.round((presents / total) * 100) : 0;

            document.getElementById('statNbEtudiantsPresence').textContent = total;
            document.getElementById('statPresents').textContent = presents;
            document.getElementById('statAbsents').textContent = absents;
            document.getElementById('statTauxPresence').textContent = tauxPresence + '%';
        }

        // Sauvegarder les présences
        async function sauvegarderPresences() {
            const matiereId = matiereSelectionneePresence;
            const dateCours = document.getElementById('inputDatePresence').value;
            
            if (!matiereId || !dateCours) {
                showToast('Veuillez sélectionner une matière et une date', 'warning');
                return;
            }

            try {
                // Préparer les données
                const presencesData = etudiantsPresence.map(e => {
                    const presence = presencesEnCours[e.id] || { present: false, justifie: false, observation: '' };
                    return {
                        etudiant_id: e.id,
                        present: presence.present,
                        justifie: presence.justifie,
                        observation: presence.observation
                    };
                });

                // TODO: Implémenter l'endpoint API pour sauvegarder les présences
                // await API.savePresences({
                //     matiere_id: matiereId,
                //     date_cours: dateCours,
                //     presences: presencesData
                // });

                console.log('Présences à sauvegarder:', {
                    matiere_id: matiereId,
                    date_cours: dateCours,
                    presences: presencesData
                });

                showToast('Présences sauvegardées avec succès!', 'success');
                
            } catch (err) {
                console.error('Erreur sauvegarde présences:', err);
                showToast('Erreur lors de la sauvegarde des présences', 'error');
            }
        }

        // Initialiser les présences au chargement de la page
        document.addEventListener('DOMContentLoaded', () => {
            const pagePresences = document.getElementById('page-presences');
            if (pagePresences) {
                chargerFilieresPresence();
            }
        });
    </script>
</body>
</html>
