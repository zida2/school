<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Enseignant ‚Äì UniERP BF Premium</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/dashboard-premium.css?v=7.0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body class="dark-theme">

    <div class="app-wrapper">
        <!-- SIDEBAR -->
        <aside class="sidebar-ultra" id="sidebar" style="border-right-color: rgba(16, 185, 129, 0.1)">
            <div class="sidebar-header">
                <div class="logo-ultra">
                    <div class="logo-icon-ultra" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%)">üë®‚Äçüè´</div>
                    <div class="logo-text-ultra">
                        <div class="logo-name-ultra">UniERP BF</div>
                        <div class="logo-tag-ultra">Espace Enseignant</div>
                    </div>
                </div>
            </div>

            <nav class="sidebar-nav-ultra">
                <div class="nav-section-ultra">
                    <div class="nav-label-ultra">PRINCIPAL</div>
                    <a href="javascript:void(0)" class="nav-item-ultra active" data-page="dashboard" onclick="navToUltra('dashboard',this)">
                        <span class="nav-icon-ultra">üìä</span>
                        <span class="nav-text-ultra">Tableau de bord</span>
                        <span class="nav-indicator" style="background: linear-gradient(135deg, #10b981, #059669)"></span>
                    </a>
                </div>

                <div class="nav-section-ultra">
                    <div class="nav-label-ultra">ENSEIGNEMENT</div>
                    <a href="javascript:void(0)" class="nav-item-ultra" data-page="emploi" onclick="navToUltra('emploi',this)">
                        <span class="nav-icon-ultra">üìÖ</span>
                        <span class="nav-text-ultra">Emploi du temps</span>
                    </a>
                    <a href="javascript:void(0)" class="nav-item-ultra" data-page="notes" onclick="navToUltra('notes',this)">
                        <span class="nav-icon-ultra">üìù</span>
                        <span class="nav-text-ultra">Saisie des notes</span>
                    </a>
                    <a href="javascript:void(0)" class="nav-item-ultra" data-page="presences" onclick="navToUltra('presences',this)">
                        <span class="nav-icon-ultra">‚úÖ</span>
                        <span class="nav-text-ultra">Pr√©sences</span>
                    </a>
                    <a href="javascript:void(0)" class="nav-item-ultra" data-page="supports" onclick="navToUltra('supports',this)">
                        <span class="nav-icon-ultra">üìÑ</span>
                        <span class="nav-text-ultra">Supports de cours</span>
                    </a>
                    <a href="javascript:void(0)" class="nav-item-ultra" data-page="etudiants" onclick="navToUltra('etudiants',this)">
                        <span class="nav-icon-ultra">üéì</span>
                        <span class="nav-text-ultra">Mes √©tudiants</span>
                    </a>
                    <a href="javascript:void(0)" class="nav-item-ultra" data-page="reclamations" onclick="navToUltra('reclamations',this)">
                        <span class="nav-icon-ultra">‚ö†Ô∏è</span>
                        <span class="nav-text-ultra">R√©clamations</span>
                        <span class="nav-badge-ultra" id="badgeReclamations">0</span>
                    </a>
                </div>
            </nav>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="main-ultra">
            <!-- TOPBAR -->
            <header class="topbar-ultra">
                <div class="topbar-left-ultra">
                    <button class="btn-menu-ultra" onclick="toggleSidebarUltra()">‚ò∞</button>
                    <div class="search-ultra">
                        <span class="search-icon-ultra">üîç</span>
                        <input type="text" class="search-input-ultra" placeholder="Rechercher...">
                    </div>
                </div>
                <div class="topbar-right-ultra">
                    <button class="topbar-btn-ultra">
                        <span>üîî</span>
                    </button>
                    <div class="user-menu-ultra" onclick="logout()">
                        <div class="user-avatar-ultra" style="background: linear-gradient(135deg, #10b981, #059669)">PR</div>
                        <div class="user-info-ultra">
                            <div class="user-name-ultra">Professeur</div>
                            <div class="user-role-ultra">Enseignant</div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- CONTENT -->
            <div class="content-ultra">
                <!-- PAGE: DASHBOARD -->
                <div class="page-ultra" id="page-dashboard">
                    <div class="page-header-ultra">
                        <div>
                            <h1 class="page-title-ultra">Tableau de bord</h1>
                            <p class="page-subtitle-ultra">Espace enseignant ¬∑ Ann√©e 2024-2025</p>
                        </div>
                    </div>

                    <!-- STATS -->
                    <div class="stats-grid-ultra">
                        <div class="stat-card-ultra success-ultra">
                            <div class="stat-icon-ultra">üìö</div>
                            <div class="stat-content-ultra">
                                <div class="stat-value-ultra" id="statMatieres">0</div>
                                <div class="stat-label-ultra">Mati√®res enseign√©es</div>
                            </div>
                        </div>

                        <div class="stat-card-ultra primary-ultra">
                            <div class="stat-icon-ultra">üéì</div>
                            <div class="stat-content-ultra">
                                <div class="stat-value-ultra" id="statEtudiants">0</div>
                                <div class="stat-label-ultra">√âtudiants</div>
                            </div>
                        </div>

                        <div class="stat-card-ultra warning-ultra">
                            <div class="stat-icon-ultra">üìù</div>
                            <div class="stat-content-ultra">
                                <div class="stat-value-ultra" id="statNotes">0</div>
                                <div class="stat-label-ultra">Notes saisies</div>
                            </div>
                        </div>

                        <div class="stat-card-ultra primary-ultra">
                            <div class="stat-icon-ultra">üìÖ</div>
                            <div class="stat-content-ultra">
                                <div class="stat-value-ultra" id="statCours">0</div>
                                <div class="stat-label-ultra">Cours cette semaine</div>
                            </div>
                        </div>
                    </div>

                    <!-- CONTENT CARDS -->
                    <div class="charts-grid-ultra">
                        <div class="card-ultra">
                            <div class="card-header-ultra">
                                <h3 class="card-title-ultra">üìÖ Emploi du temps</h3>
                            </div>
                            <div class="card-body-ultra">
                                <p style="color:rgba(255,255,255,0.6)">Vos cours de la semaine</p>
                            </div>
                        </div>

                        <div class="card-ultra">
                            <div class="card-header-ultra">
                                <h3 class="card-title-ultra">üìä Statistiques</h3>
                            </div>
                            <div class="card-body-ultra">
                                <p style="color:rgba(255,255,255,0.6)">Vue d'ensemble de vos cours</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PAGE: SUPPORTS -->
                <div class="page-ultra" id="page-supports" style="display:none">
                    <div class="page-header-ultra">
                        <div>
                            <h1 class="page-title-ultra">Supports de cours</h1>
                            <p class="page-subtitle-ultra">G√©rez vos documents p√©dagogiques</p>
                        </div>
                        <div class="page-actions-ultra">
                            <button class="btn-ultra btn-primary-ultra" onclick="openModal('modalSupport')" style="background: linear-gradient(135deg, #10b981, #059669)">+ Ajouter un support</button>
                        </div>
                    </div>

                    <div class="card-ultra">
                        <div class="card-body-ultra" style="padding:0">
                            <table class="table-ultra">
                                <thead>
                                    <tr>
                                        <th>Titre</th>
                                        <th>Mati√®re</th>
                                        <th>Type</th>
                                        <th>Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="tbodySupports">
                                    <tr><td colspan="5" style="text-align:center;padding:40px">Chargement...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- OTHER PAGES -->
                <div class="page-ultra" id="page-emploi" style="display:none">
                    <div class="page-header-ultra">
                        <h1 class="page-title-ultra">üìÖ Emploi du temps</h1>
                        <p class="page-subtitle-ultra">Votre planning de la semaine</p>
                    </div>
                    <div class="card-ultra">
                        <div class="card-body-ultra">
                            <div style="overflow-x:auto">
                                <table class="table-ultra">
                                    <thead>
                                        <tr>
                                            <th>Jour</th>
                                            <th>Heure</th>
                                            <th>Mati√®re</th>
                                            <th>Fili√®re</th>
                                            <th>Salle</th>
                                            <th>Type</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbodyEmploiProf">
                                        <tr><td colspan="6" style="text-align:center;padding:40px">Chargement...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PAGE: GESTION DES √âVALUATIONS ET NOTES -->
                <div class="page-ultra" id="page-notes" style="display:none">
                    <div class="page-header-ultra">
                        <div>
                            <h1 class="page-title-ultra">Gestion des √âvaluations et Notes</h1>
                            <p class="page-subtitle-ultra">Cr√©ez des √©valuations et saisissez les notes</p>
                        </div>
                    </div>

                    <!-- S√©lection de la mati√®re -->
                    <div class="card-ultra" style="margin-bottom:24px">
                        <div class="card-body-ultra">
                            <div class="form-group-ultra">
                                <label class="form-label-ultra">S√©lectionner une mati√®re *</label>
                                <select id="selectMatiereNotes" class="form-input-ultra" onchange="chargerEvaluationsMatiere()" style="padding:12px 16px">
                                    <option value="">Choisir une mati√®re...</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Contenu principal (visible apr√®s s√©lection mati√®re) -->
                    <div id="contenuEvaluations" style="display:none">
                        
                        <!-- Statistiques -->
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px">
                            <div style="background:rgba(99,102,241,0.1);border:1px solid rgba(99,102,241,0.2);border-radius:12px;padding:20px">
                                <div style="font-size:28px;font-weight:700;color:#6366f1" id="statNbEvaluations">0</div>
                                <div style="font-size:13px;color:rgba(255,255,255,0.7);margin-top:4px">√âvaluations cr√©√©es</div>
                            </div>
                            <div style="background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.2);border-radius:12px;padding:20px">
                                <div style="font-size:28px;font-weight:700;color:#10b981" id="statNbEtudiants">0</div>
                                <div style="font-size:13px;color:rgba(255,255,255,0.7);margin-top:4px">√âtudiants</div>
                            </div>
                            <div style="background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.2);border-radius:12px;padding:20px">
                                <div style="font-size:28px;font-weight:700;color:#f59e0b" id="statNotesSaisies">0</div>
                                <div style="font-size:13px;color:rgba(255,255,255,0.7);margin-top:4px">Notes saisies</div>
                            </div>
                        </div>

                        <!-- Liste des √©valuations -->
                        <div class="card-ultra" style="margin-bottom:24px">
                            <div class="card-header-ultra">
                                <h3 class="card-title-ultra">üìã √âvaluations</h3>
                                <button class="btn-ultra btn-primary-ultra" onclick="ouvrirModalEvaluation()" style="background: linear-gradient(135deg, #10b981, #059669)">
                                    + Nouvelle √©valuation
                                </button>
                            </div>
                            <div class="card-body-ultra">
                                <div id="listeEvaluations" style="display:grid;gap:16px">
                                    <div style="text-align:center;padding:40px;color:rgba(255,255,255,0.5)">
                                        Aucune √©valuation. Cr√©ez-en une pour commencer.
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <div class="page-ultra" id="page-presences" style="display:none">
                    <div class="page-header-ultra">
                        <h1 class="page-title-ultra">Gestion des pr√©sences</h1>
                    </div>
                    <div class="card-ultra">
                        <div class="card-body-ultra">
                            <p style="color:rgba(255,255,255,0.6)">Suivi des pr√©sences √©tudiants</p>
                        </div>
                    </div>
                </div>

                <div class="page-ultra" id="page-etudiants" style="display:none">
                    <div class="page-header-ultra">
                        <div>
                            <h1 class="page-title-ultra">Mes √©tudiants</h1>
                            <p class="page-subtitle-ultra">√âtudiants inscrits dans vos mati√®res</p>
                        </div>
                    </div>

                    <!-- Filtres -->
                    <div class="card-ultra" style="margin-bottom:24px">
                        <div class="card-body-ultra">
                            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px">
                                <div>
                                    <input type="text" id="searchEtudiantsProf" class="search-input-ultra" placeholder="üîç Rechercher..." 
                                        style="width:100%;padding:12px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:#fff"
                                        onkeyup="filtrerEtudiantsProf()">
                                </div>
                                <div>
                                    <select id="filterMatiereProf" class="form-input-ultra" onchange="filtrerEtudiantsProf()" style="width:100%;padding:12px 16px">
                                        <option value="">üìö Toutes mes mati√®res</option>
                                    </select>
                                </div>
                                <div>
                                    <select id="filterNiveauProf" class="form-input-ultra" onchange="filtrerEtudiantsProf()" style="width:100%;padding:12px 16px">
                                        <option value="">üéì Tous les niveaux</option>
                                        <option value="L1">Licence 1</option>
                                        <option value="L2">Licence 2</option>
                                        <option value="L3">Licence 3</option>
                                        <option value="M1">Master 1</option>
                                        <option value="M2">Master 2</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Statistiques -->
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;margin-bottom:24px">
                        <div style="padding:16px;background:rgba(16,185,129,0.1);border-radius:12px;border:1px solid rgba(16,185,129,0.2);text-align:center">
                            <div style="font-size:24px;font-weight:700;color:#10b981" id="statTotalEtudiantsProf">0</div>
                            <div style="font-size:12px;color:rgba(255,255,255,0.6)">Total √©tudiants</div>
                        </div>
                        <div style="padding:16px;background:rgba(99,102,241,0.1);border-radius:12px;border:1px solid rgba(99,102,241,0.2);text-align:center">
                            <div style="font-size:24px;font-weight:700;color:#6366f1" id="statFilieresProf">0</div>
                            <div style="font-size:12px;color:rgba(255,255,255,0.6)">Fili√®res</div>
                        </div>
                    </div>

                    <!-- Tableau -->
                    <div class="card-ultra">
                        <div class="card-body-ultra">
                            <div style="overflow-x:auto">
                                <table class="table-ultra">
                                    <thead>
                                        <tr>
                                            <th>Matricule</th>
                                            <th>Nom complet</th>
                                            <th>Fili√®re</th>
                                            <th>Niveau</th>
                                            <th>Email</th>
                                            <th>T√©l√©phone</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbodyEtudiantsProf">
                                        <tr><td colspan="6" style="text-align:center;padding:40px">Chargement...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PAGE: R√âCLAMATIONS -->
                <div class="page-ultra" id="page-reclamations" style="display:none">
                    <div class="page-header-ultra">
                        <div>
                            <h1 class="page-title-ultra">R√©clamations sur les notes</h1>
                            <p class="page-subtitle-ultra">R√©clamations de vos √©tudiants</p>
                        </div>
                    </div>

                    <div class="card-ultra">
                        <div class="card-body-ultra">
                            <!-- Filtres -->
                            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px">
                                <div>
                                    <select id="filtreStatutReclamationProf" class="form-input-ultra" onchange="filtrerReclamationsProf()" style="width:100%;padding:12px 16px">
                                        <option value="">Tous les statuts</option>
                                        <option value="en_attente">En attente</option>
                                        <option value="resolue">R√©solue</option>
                                        <option value="rejetee">Rejet√©e</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Tableau -->
                            <div style="overflow-x:auto">
                                <table class="table-ultra">
                                    <thead>
                                        <tr>
                                            <th>√âtudiant</th>
                                            <th>Mati√®re</th>
                                            <th>Note CC</th>
                                            <th>Note Examen</th>
                                            <th>Moyenne</th>
                                            <th>Date</th>
                                            <th>Statut</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbodyReclamationsProf">
                                        <tr><td colspan="8" style="text-align:center;padding:40px">Chargement...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MODAL VOIR R√âCLAMATION -->
                <div class="modal-ultra" id="modalVoirReclamationProf">
                    <div class="modal-content-ultra">
                        <div class="modal-header-ultra">
                            <h3>‚ö†Ô∏è D√©tails de la r√©clamation</h3>
                            <span class="modal-close-ultra" onclick="closeModal('modalVoirReclamationProf')">&times;</span>
                        </div>
                        <div class="modal-body-ultra">
                            <div id="detailsReclamationProf" style="line-height:1.8">
                                <!-- Rempli dynamiquement -->
                            </div>
                        </div>
                        <div class="modal-footer-ultra">
                            <button type="button" class="btn-ultra btn-ghost-ultra" onclick="closeModal('modalVoirReclamationProf')">Fermer</button>
                        </div>
                    </div>
                </div>

                <!-- MODAL TRAITER R√âCLAMATION -->
                <div class="modal-ultra" id="modalTraiterReclamation">
                    <div class="modal-content-ultra" style="max-width:700px">
                        <div class="modal-header-ultra">
                            <h3>‚ö†Ô∏è Traiter la r√©clamation</h3>
                            <span class="modal-close-ultra" onclick="closeModal('modalTraiterReclamation')">&times;</span>
                        </div>
                        <div class="modal-body-ultra">
                            <div id="reclamationInfo" style="padding:15px;background:rgba(255,255,255,0.05);border-radius:8px;margin-bottom:20px">
                                <!-- Info r√©clamation -->
                            </div>
                            
                            <div style="padding:15px;background:rgba(255,255,255,0.05);border-radius:8px;margin-bottom:20px">
                                <strong style="font-size:13px;color:rgba(255,255,255,0.7)">DESCRIPTION:</strong>
                                <p id="reclamationDescription" style="margin-top:10px;color:#fff"></p>
                            </div>
                            
                            <form id="formTraiterReclamation" onsubmit="envoyerTraitementReclamation(event)">
                                <div class="form-group-ultra">
                                    <label class="form-label-ultra">D√©cision *</label>
                                    <select id="decisionReclamation" required class="form-input-ultra">
                                        <option value="">Choisir...</option>
                                        <option value="resolue">Accepter (R√©soudre)</option>
                                        <option value="rejetee">Rejeter</option>
                                    </select>
                                </div>
                                
                                <div class="form-group-ultra">
                                    <label class="form-label-ultra">R√©ponse √† l'√©tudiant *</label>
                                    <textarea id="reponseReclamation" rows="4" required class="form-input-ultra" placeholder="Expliquez votre d√©cision..."></textarea>
                                </div>
                                
                                <div id="correctionNote" style="display:none;padding:20px;background:rgba(16,185,129,0.1);border-radius:12px;border:1px solid rgba(16,185,129,0.2);margin-top:20px">
                                    <h4 style="margin-bottom:16px;color:#10b981">‚úèÔ∏è Correction de la note</h4>
                                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
                                        <div class="form-group-ultra">
                                            <label class="form-label-ultra">Nouvelle note CC</label>
                                            <input type="number" id="nouvelleNoteCC" min="0" max="20" step="0.5" class="form-input-ultra" placeholder="Ex: 15">
                                        </div>
                                        <div class="form-group-ultra">
                                            <label class="form-label-ultra">Nouvelle note Examen</label>
                                            <input type="number" id="nouvelleNoteExamen" min="0" max="20" step="0.5" class="form-input-ultra" placeholder="Ex: 16">
                                        </div>
                                    </div>
                                    <p style="font-size:13px;color:rgba(255,255,255,0.7);margin-top:12px">
                                        üí° La moyenne sera recalcul√©e automatiquement
                                    </p>
                                </div>
                                
                                <div class="modal-footer-ultra">
                                    <button type="button" class="btn-ultra btn-ghost-ultra" onclick="closeModal('modalTraiterReclamation')">Annuler</button>
                                    <button type="submit" class="btn-ultra btn-primary-ultra">Envoyer</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODAL SUPPORT -->
    <div class="modal-ultra" id="modalSupport" style="display:none">
        <div class="modal-content-ultra">
            <div class="modal-header-ultra">
                <h3>üìÑ Ajouter un support</h3>
                <span class="modal-close-ultra" onclick="closeModal('modalSupport')">&times;</span>
            </div>
            <div class="modal-body-ultra">
                <form id="formSupport" onsubmit="ajouterSupport(event)">
                    <div class="form-group-ultra">
                        <label class="form-label-ultra">Titre</label>
                        <input type="text" name="titre" required class="form-input-ultra">
                    </div>
                    <div class="form-group-ultra">
                        <label class="form-label-ultra">Mati√®re</label>
                        <select name="matiere" required id="selectMatiereSupport" class="form-input-ultra">
                            <option value="">S√©lectionner</option>
                        </select>
                    </div>
                    <div class="form-group-ultra">
                        <label class="form-label-ultra">Type</label>
                        <select name="type_support" required class="form-input-ultra">
                            <option value="cours">Cours</option>
                            <option value="td">TD</option>
                            <option value="tp">TP</option>
                            <option value="examen_corrige">Examen corrig√©</option>
                            <option value="ressource">Ressource</option>
                        </select>
                    </div>
                    <div class="form-group-ultra">
                        <label class="form-label-ultra">Fichier (optionnel)</label>
                        <input type="file" name="fichier" accept=".pdf,.doc,.docx,.ppt,.pptx" class="form-input-ultra">
                    </div>
                    <div class="form-group-ultra">
                        <label class="form-label-ultra">Description</label>
                        <textarea name="description" rows="3" class="form-input-ultra"></textarea>
                    </div>
                    <div class="form-group-ultra">
                        <label style="display:flex;align-items:center;gap:8px;color:rgba(255,255,255,0.8)">
                            <input type="checkbox" name="visible" checked>
                            <span>Visible pour les √©tudiants</span>
                        </label>
                    </div>
                    <div class="modal-footer-ultra">
                        <button type="button" class="btn-ultra btn-ghost-ultra" onclick="closeModal('modalSupport')">Annuler</button>
                        <button type="submit" class="btn-ultra btn-primary-ultra" style="background: linear-gradient(135deg, #10b981, #059669)">Publier</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL: CR√âER/MODIFIER √âVALUATION -->
    <div class="modal-ultra" id="modalEvaluation" style="display:none">
        <div class="modal-content-ultra" style="max-width:600px">
            <div class="modal-header-ultra">
                <h3 id="modalEvaluationTitle">üìù Nouvelle √©valuation</h3>
                <span class="modal-close-ultra" onclick="closeModal('modalEvaluation')">&times;</span>
            </div>
            <div class="modal-body-ultra">
                <form id="formEvaluation" onsubmit="sauvegarderEvaluation(event)">
                    <input type="hidden" id="editEvalId">
                    
                    <div class="form-group-ultra">
                        <label class="form-label-ultra">Titre *</label>
                        <input type="text" name="titre" id="editEvalTitre" required class="form-input-ultra" 
                            placeholder="Ex: Devoir 1 - Algorithmique">
                    </div>

                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
                        <div class="form-group-ultra">
                            <label class="form-label-ultra">Type *</label>
                            <select name="type_evaluation" id="editEvalType" required class="form-input-ultra">
                                <option value="devoir">üìù Devoir</option>
                                <option value="interrogation">üìÑ Interrogation</option>
                                <option value="tp">üî¨ TP</option>
                                <option value="projet">üíº Projet</option>
                                <option value="examen">üìã Examen</option>
                                <option value="oral">üé§ Oral</option>
                            </select>
                        </div>
                        <div class="form-group-ultra">
                            <label class="form-label-ultra">Cat√©gorie *</label>
                            <select name="categorie" id="editEvalCategorie" required class="form-input-ultra">
                                <option value="cc">CC (40%)</option>
                                <option value="examen">Examen (60%)</option>
                            </select>
                        </div>
                    </div>

                    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px">
                        <div class="form-group-ultra">
                            <label class="form-label-ultra">Coefficient *</label>
                            <input type="number" name="coefficient" id="editEvalCoef" required class="form-input-ultra" 
                                min="1" max="10" value="1">
                        </div>
                        <div class="form-group-ultra">
                            <label class="form-label-ultra">Note sur *</label>
                            <input type="number" name="note_sur" id="editEvalNoteSur" required class="form-input-ultra" 
                                min="1" max="100" value="20" step="0.01">
                        </div>
                        <div class="form-group-ultra">
                            <label class="form-label-ultra">Date *</label>
                            <input type="date" name="date_evaluation" id="editEvalDate" required class="form-input-ultra">
                        </div>
                    </div>

                    <div class="form-group-ultra">
                        <label class="form-label-ultra">Description</label>
                        <textarea name="description" id="editEvalDescription" class="form-input-ultra" rows="3" 
                            placeholder="Description de l'√©valuation..."></textarea>
                    </div>

                    <div class="modal-footer-ultra">
                        <button type="button" class="btn-ultra btn-ghost-ultra" onclick="closeModal('modalEvaluation')">Annuler</button>
                        <button type="submit" class="btn-ultra btn-primary-ultra" style="background: linear-gradient(135deg, #10b981, #059669)">Enregistrer</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL: SAISIR LES NOTES D'UNE √âVALUATION -->
    <div class="modal-ultra" id="modalSaisieNotes" style="display:none">
        <div class="modal-content-ultra" style="max-width:1000px;max-height:90vh;overflow-y:auto">
            <div class="modal-header-ultra">
                <h3 id="modalSaisieTitle">üìù Saisie des notes</h3>
                <span class="modal-close-ultra" onclick="closeModal('modalSaisieNotes')">&times;</span>
            </div>
            <div class="modal-body-ultra">
                <div id="infoEvaluation" style="background:rgba(99,102,241,0.1);padding:16px;border-radius:8px;margin-bottom:20px">
                    <!-- Info √©valuation -->
                </div>
                
                <div style="margin-bottom:16px;display:flex;justify-content:space-between;align-items:center">
                    <div>
                        <span id="progressNotes" style="color:rgba(255,255,255,0.7)">0/0 notes saisies</span>
                    </div>
                    <button class="btn-ultra btn-primary-ultra" onclick="sauvegarderToutesNotesEval()" style="background: linear-gradient(135deg, #10b981, #059669)">
                        üíæ Sauvegarder tout
                    </button>
                </div>

                <div style="overflow-x:auto">
                    <table class="table-ultra">
                        <thead>
                            <tr>
                                <th style="width:50px">#</th>
                                <th>Matricule</th>
                                <th>Nom complet</th>
                                <th style="width:150px">Note</th>
                                <th style="width:100px">Absent</th>
                                <th style="width:200px">Commentaire</th>
                            </tr>
                        </thead>
                        <tbody id="tbodyNotesEval">
                            <!-- Lignes √©tudiants -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Charger les scripts externes d'abord -->
    <script src="js/mock-data.js?v=7"></script>
    <script src="js/api.js?v=7"></script>
    <script src="js/fix-navigation.js?v=7"></script>
    <script src="js/theme-toggle.js?v=7"></script>

    <!-- Puis le script inline qui utilise ces fonctions -->
    <script>
        // V√©rification d'authentification - Attendre le chargement complet
        window.addEventListener('DOMContentLoaded', function() {
            // Attendre un peu que les scripts externes soient charg√©s
            setTimeout(function() {
                console.log('üîç V√©rification authentification dashboard-prof...');
                console.log('Auth d√©fini?', typeof Auth !== 'undefined');
                console.log('isLoggedIn?', typeof Auth !== 'undefined' ? Auth.isLoggedIn() : 'Auth non d√©fini');
                
                if (typeof Auth === 'undefined' || !Auth.isLoggedIn()) {
                    console.log('‚ùå Non connect√©, redirection vers index.html');
                    window.location.replace('index.html');
                    return;
                }

                const user = Auth.getUser();
                console.log('üë§ Utilisateur:', user);
                
                if (!user) {
                    console.log('‚ùå Pas de donn√©es utilisateur, redirection vers index.html');
                    Auth.clear();
                    window.location.replace('index.html');
                    return;
                }

                // V√©rifier que l'utilisateur a le r√¥le enseignant ou professeur
                const role = user.role;
                console.log('üé≠ R√¥le:', role);
                
                if (role !== 'enseignant' && role !== 'professeur') {
                    console.log('‚ùå R√¥le incorrect:', role, '- Redirection vers le bon dashboard');
                    if (role === 'admin' || role === 'superadmin' || role === 'administrateur') {
                        window.location.replace('dashboard-admin.html');
                    } else if (role === 'etudiant') {
                        window.location.replace('dashboard-etudiant.html');
                    } else if (role === 'bureau_executif') {
                        window.location.replace('dashboard-bureau.html');
                    } else {
                        Auth.clear();
                        window.location.replace('index.html');
                    }
                    return;
                }

                console.log('‚úÖ Authentification OK - R√¥le:', role);
            }, 500); // Augment√© √† 500ms pour laisser le temps aux tokens d'√™tre sauvegard√©s
        });

        window.navToUltra = function(page, el) {
            console.log('üîÑ Navigation vers:', page);
            document.querySelectorAll('.page-ultra').forEach(p => p.style.display = 'none');
            const target = document.getElementById('page-' + page);
            if (target) {
                target.style.display = 'block';
                console.log('‚úÖ Page affich√©e:', page);
            } else {
                console.error('‚ùå Page non trouv√©e:', 'page-' + page);
            }
            
            document.querySelectorAll('.nav-item-ultra').forEach(i => i.classList.remove('active'));
            if (el) el.classList.add('active');

            // Charger les donn√©es sp√©cifiques √† la page
            if (page === 'etudiants') {
                chargerMesEtudiants();
            } else if (page === 'supports') {
                chargerSupports();
            } else if (page === 'notes') {
                chargerMatieresNotes();
            } else if (page === 'emploi') {
                chargerEmploiProf();
            }
        }

        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('open');
                document.body.style.overflow = 'hidden';
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('open');
                document.body.style.overflow = '';
            }
        }

        function showToast(message, type = 'info') {
            const icons = { success: '‚úÖ', danger: '‚ùå', warning: '‚ö†Ô∏è', info: '‚ÑπÔ∏è' };
            let container = document.getElementById('toast-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toast-container';
                container.style.cssText = 'position:fixed;top:20px;right:20px;z-index:9999;display:flex;flex-direction:column;gap:10px;';
                document.body.appendChild(container);
            }
            const toast = document.createElement('div');
            const colors = { success: '#059669', danger: '#dc2626', warning: '#d97706', info: '#2563eb' };
            toast.style.cssText = `background:rgba(10,14,39,0.95);border-radius:12px;padding:14px 18px;box-shadow:0 8px 32px rgba(0,0,0,.3);display:flex;align-items:center;gap:12px;min-width:280px;max-width:400px;border-left:4px solid ${colors[type]};animation:slideIn .3s ease;backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.1)`;
            toast.innerHTML = `<span style="font-size:18px">${icons[type]}</span><span style="font-size:14px;font-weight:500;flex:1;color:#fff">${message}</span><span onclick="this.parentElement.remove()" style="cursor:pointer;color:#94a3b8;flex-shrink:0;font-size:18px">‚úï</span>`;
            container.appendChild(toast);
            setTimeout(() => { if (toast.parentElement) toast.remove(); }, 3500);
        }

        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            const date = new Date(dateStr);
            return date.toLocaleDateString('fr-FR');
        }

        async function chargerMatieres() {
            try {
                const dashboard = await API.getDashboardProf();
                if (dashboard && dashboard.matieres) {
                    const select = document.getElementById('selectMatiereSupport');
                    select.innerHTML = '<option value="">S√©lectionner</option>' + 
                        dashboard.matieres.map(m => `<option value="${m.id}">${m.nom}</option>`).join('');
                }
            } catch (err) {
                console.error('Erreur:', err);
            }
        }

        async function chargerSupports() {
            try {
                const supports = await API.getSupports();
                const tbody = document.getElementById('tbodySupports');
                
                if (supports && supports.length > 0) {
                    tbody.innerHTML = supports.map(s => `
                        <tr>
                            <td style="font-weight:600">${s.titre}</td>
                            <td>${s.matiere_nom || 'N/A'}</td>
                            <td><span class="badge-ultra success">${s.type_support}</span></td>
                            <td>${formatDate(s.date_depot)}</td>
                            <td>
                                <button class="btn-ultra btn-ghost-ultra btn-sm-ultra">üì•</button>
                                <button class="btn-ultra btn-ghost-ultra btn-sm-ultra" onclick="supprimerSupport(${s.id})">üóëÔ∏è</button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:40px;color:rgba(255,255,255,0.5)">Aucun support</td></tr>';
                }
            } catch (err) {
                console.error('Erreur:', err);
            }
        }

        async function ajouterSupport(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);

            try {
                const me = await API.getMe();
                const uploadData = new FormData();
                uploadData.append('titre', formData.get('titre'));
                uploadData.append('matiere', formData.get('matiere'));
                uploadData.append('enseignant', me.enseignant.id);
                uploadData.append('type_support', formData.get('type_support'));
                uploadData.append('description', formData.get('description') || '');
                uploadData.append('visible', formData.get('visible') ? 'true' : 'false');
                
                const fichier = formData.get('fichier');
                if (fichier && fichier.size > 0) {
                    uploadData.append('fichier', fichier);
                }

                await API.createSupport(uploadData);
                showToast('Support publi√© !', 'success');
                closeModal('modalSupport');
                form.reset();
                chargerSupports();
            } catch (err) {
                showToast('Erreur : ' + err.message, 'danger');
            }
        }

        async function supprimerSupport(id) {
            if (!confirm('Supprimer ce support ?')) return;
            try {
                await API.deleteSupport(id);
                showToast('Support supprim√©', 'success');
                chargerSupports();
            } catch (err) {
                showToast('Erreur', 'danger');
            }
        }

        // Charger l'emploi du temps de l'enseignant
        async function chargerEmploiProf() {
            try {
                const tbody = document.getElementById('tbodyEmploiProf');
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px">Chargement...</td></tr>';

                // R√©cup√©rer les donn√©es du dashboard pour avoir les mati√®res de l'enseignant
                const dashboard = await API.getDashboardProf();
                const mesMatieres = dashboard.matieres || [];
                const mesMatieresIds = mesMatieres.map(m => m.id);

                // R√©cup√©rer tous les emplois du temps
                const emplois = await API.getEmploisDuTemps();
                
                // Filtrer pour ne garder que les cours de l'enseignant
                const mesEmplois = emplois.filter(e => mesMatieresIds.includes(e.matiere));

                // Ordre des jours
                const ordreJours = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi', 'Dimanche'];
                
                // Trier par jour puis par heure
                mesEmplois.sort((a, b) => {
                    const jourA = ordreJours.indexOf(a.jour);
                    const jourB = ordreJours.indexOf(b.jour);
                    if (jourA !== jourB) return jourA - jourB;
                    return a.heure_debut.localeCompare(b.heure_debut);
                });

                if (mesEmplois.length > 0) {
                    tbody.innerHTML = mesEmplois.map(e => {
                        // Trouver le nom de la fili√®re
                        const matiere = mesMatieres.find(m => m.id === e.matiere);
                        const filiereNom = matiere ? matiere.filiere_nom : 'N/A';
                        
                        return `
                            <tr>
                                <td><strong>${e.jour}</strong></td>
                                <td>${e.heure_debut} - ${e.heure_fin}</td>
                                <td>${e.matiere_nom}</td>
                                <td>${filiereNom}</td>
                                <td><span class="badge-ultra primary">${e.salle}</span></td>
                                <td><span class="badge-ultra success">Cours</span></td>
                            </tr>
                        `;
                    }).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;color:rgba(255,255,255,0.5)">Aucun cours programm√©</td></tr>';
                }
            } catch (err) {
                console.error('Erreur chargement emploi:', err);
                const tbody = document.getElementById('tbodyEmploiProf');
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;color:rgba(255,255,255,0.5)">Erreur de chargement</td></tr>';
            }
        }

        let tousLesEtudiantsProf = [];
        let etudiantsProfFiltres = [];
        let mesMatieres = [];

        async function chargerMesEtudiants() {
            try {
                const dashboard = await API.getDashboardProf();
                mesMatieres = dashboard.matieres || [];

                // R√©cup√©rer toutes les fili√®res de mes mati√®res
                const filieresIds = [...new Set(mesMatieres.map(m => m.filiere))];
                
                // R√©cup√©rer tous les √©tudiants de ces fili√®res
                const promesses = filieresIds.map(filiereId => API.getEtudiants({ filiere: filiereId }));
                const resultats = await Promise.all(promesses);
                
                // Fusionner tous les √©tudiants et supprimer les doublons
                const etudiantsMap = new Map();
                resultats.flat().forEach(e => {
                    if (!etudiantsMap.has(e.id)) {
                        etudiantsMap.set(e.id, e);
                    }
                });
                
                tousLesEtudiantsProf = Array.from(etudiantsMap.values());
                etudiantsProfFiltres = tousLesEtudiantsProf;

                // Remplir le filtre des mati√®res
                document.getElementById('filterMatiereProf').innerHTML = 
                    '<option value="">üìö Toutes mes mati√®res</option>' +
                    mesMatieres.map(m => `<option value="${m.filiere}">${m.nom}</option>`).join('');

                // Mettre √† jour les stats
                document.getElementById('statTotalEtudiantsProf').textContent = tousLesEtudiantsProf.length;
                document.getElementById('statFilieresProf').textContent = filieresIds.length;
                document.getElementById('statEtudiants').textContent = tousLesEtudiantsProf.length;

                afficherEtudiantsProf();
            } catch (err) {
                console.error('Erreur:', err);
                showToast('Erreur de chargement: ' + err.message, 'danger');
                document.getElementById('tbodyEtudiantsProf').innerHTML = 
                    '<tr><td colspan="6" style="text-align:center;padding:40px;color:rgba(255,255,255,0.5)">Erreur de chargement</td></tr>';
            }
        }

        function filtrerEtudiantsProf() {
            const searchValue = document.getElementById('searchEtudiantsProf').value.toLowerCase();
            const filterMatiere = document.getElementById('filterMatiereProf').value;
            const filterNiveau = document.getElementById('filterNiveauProf').value;

            etudiantsProfFiltres = tousLesEtudiantsProf.filter(e => {
                const matchSearch = !searchValue || 
                    e.matricule.toLowerCase().includes(searchValue) ||
                    e.prenom.toLowerCase().includes(searchValue) ||
                    e.nom.toLowerCase().includes(searchValue) ||
                    e.email.toLowerCase().includes(searchValue);
                
                const matchMatiere = !filterMatiere || e.filiere == filterMatiere;
                const matchNiveau = !filterNiveau || e.niveau === filterNiveau;

                return matchSearch && matchMatiere && matchNiveau;
            });

            afficherEtudiantsProf();
        }

        function afficherEtudiantsProf() {
            const tbody = document.getElementById('tbodyEtudiantsProf');
            
            if (etudiantsProfFiltres.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;color:rgba(255,255,255,0.5)">Aucun √©tudiant trouv√©</td></tr>';
                return;
            }

            tbody.innerHTML = etudiantsProfFiltres.map(e => `
                <tr>
                    <td data-label="Matricule" style="font-weight:600">${e.matricule}</td>
                    <td data-label="Nom">${e.prenom} ${e.nom}</td>
                    <td data-label="Fili√®re">${e.filiere_nom || 'N/A'}</td>
                    <td data-label="Niveau"><span class="badge-ultra primary">${e.niveau}</span></td>
                    <td data-label="Email">${e.email}</td>
                    <td data-label="T√©l√©phone">${e.telephone || 'N/A'}</td>
                </tr>
            `).join('');
        }

        async function chargerDashboard() {
            try {
                console.log('üîÑ Chargement du dashboard...');
                
                // Charger les donn√©es
                const me = await API.getMe();
                console.log('‚úÖ Me:', me);
                
                const dashboard = await API.getDashboardProf();
                console.log('‚úÖ Dashboard:', dashboard);
                
                const matieres = dashboard.matieres || [];
                console.log('‚úÖ Mati√®res:', matieres.length);
                
                if (matieres.length === 0) {
                    console.warn('‚ö†Ô∏è Aucune mati√®re trouv√©e');
                    return;
                }
                
                // R√©cup√©rer les fili√®res de toutes les mati√®res
                const filieresIds = [...new Set(matieres.map(m => m.filiere))];
                console.log('‚úÖ Fili√®res:', filieresIds);
                
                // Charger tous les √©tudiants des fili√®res
                const promesses = filieresIds.map(filiereId => API.getEtudiants({ filiere: filiereId }));
                const resultats = await Promise.all(promesses);
                console.log('‚úÖ R√©sultats √©tudiants:', resultats);
                
                // Fusionner et d√©dupliquer les √©tudiants
                const etudiantsMap = new Map();
                resultats.flat().forEach(e => {
                    if (!etudiantsMap.has(e.id)) {
                        etudiantsMap.set(e.id, e);
                    }
                });
                const totalEtudiants = etudiantsMap.size;
                console.log('‚úÖ Total √©tudiants:', totalEtudiants);
                
                // Charger toutes les notes de l'enseignant
                const toutesLesNotes = [];
                for (const matiere of matieres) {
                    const notes = await API.getNotes({ matiere: matiere.id });
                    toutesLesNotes.push(...notes);
                }
                console.log('‚úÖ Total notes:', toutesLesNotes.length);
                
                // Compter les notes saisies (au moins CC ou Examen)
                const notesSaisies = toutesLesNotes.filter(n => 
                    n.note_cc !== null || n.note_examen !== null
                ).length;
                console.log('‚úÖ Notes saisies:', notesSaisies);
                
                // Charger l'emploi du temps
                const emplois = await API.getEmploisDuTemps();
                const mesEmplois = emplois.filter(e => matieres.some(m => m.id === e.matiere));
                const totalCours = mesEmplois.length;
                console.log('‚úÖ Total cours:', totalCours);
                
                // Mettre √† jour les statistiques
                const statMatieres = document.getElementById('statMatieres');
                const statEtudiants = document.getElementById('statEtudiants');
                const statNotes = document.getElementById('statNotes');
                const statCours = document.getElementById('statCours');
                
                if (statMatieres) statMatieres.textContent = matieres.length;
                if (statEtudiants) statEtudiants.textContent = totalEtudiants;
                if (statNotes) statNotes.textContent = notesSaisies;
                if (statCours) statCours.textContent = totalCours;
                
                console.log('‚úÖ Dashboard charg√© avec succ√®s:', {
                    matieres: matieres.length,
                    etudiants: totalEtudiants,
                    notes: notesSaisies,
                    cours: totalCours
                });
                
            } catch (err) {
                console.error('‚ùå Erreur chargement dashboard:', err);
                showToast('Erreur de chargement du dashboard', 'danger');
            }
        }

        let matiereSelectionneeProfProf = null;
        let etudiantsMatiere = [];
        let evaluationsMatiere = [];
        let evaluationEnCours = null;
        let notesEvalEnCours = {};

        async function chargerMatieresNotes() {
            try {
                const dashboard = await API.getDashboardProf();
                const matieres = dashboard.matieres || [];
                
                const select = document.getElementById('selectMatiereNotes');
                select.innerHTML = '<option value="">Choisir une mati√®re...</option>' +
                    matieres.map(m => `<option value="${m.id}" data-coef="${m.coefficient}" data-nom="${m.nom}" data-filiere="${m.filiere}">${m.nom} (${m.filiere_nom || 'N/A'})</option>`).join('');
            } catch (err) {
                console.error('Erreur:', err);
                showToast('Erreur de chargement des mati√®res', 'danger');
            }
        }

        async function chargerEtudiantsMatiere() {
            const selectMatiere = document.getElementById('selectMatiereNotes');
            const matiereId = selectMatiere.value;
            
            if (!matiereId) {
                document.getElementById('infoMatiere').style.display = 'none';
                document.getElementById('tbodyNotes').innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align:center;padding:60px;color:rgba(255,255,255,0.5)">
                            <div style="font-size:48px;margin-bottom:16px">üìù</div>
                            <div style="font-size:16px;font-weight:600;margin-bottom:8px">S√©lectionnez une mati√®re</div>
                            <div style="font-size:14px">Choisissez une mati√®re ci-dessus pour commencer la saisie des notes</div>
                        </td>
                    </tr>`;
                return;
            }

            try {
                // R√©cup√©rer les infos de la mati√®re
                const selectedOption = selectMatiere.options[selectMatiere.selectedIndex];
                const matiereNom = selectedOption.getAttribute('data-nom');
                const matiereCoef = selectedOption.getAttribute('data-coef');
                
                matiereSelectionneeProf = {
                    id: matiereId,
                    nom: matiereNom,
                    coefficient: matiereCoef
                };

                // R√©cup√©rer la mati√®re compl√®te pour avoir la fili√®re
                const matieres = await API.getMatieres();
                const matiere = matieres.find(m => m.id == matiereId);
                
                if (!matiere) {
                    showToast('Mati√®re non trouv√©e', 'danger');
                    return;
                }

                // R√©cup√©rer tous les √©tudiants de la fili√®re
                const etudiants = await API.getEtudiants({ filiere: matiere.filiere });
                etudiantsMatiere = etudiants;

                // R√©cup√©rer les notes existantes
                const notes = await API.getNotes({ matiere: matiereId });
                
                // Cr√©er un map des notes par √©tudiant
                const notesMap = {};
                notes.forEach(n => {
                    notesMap[n.etudiant] = n;
                });

                // Afficher les infos
                document.getElementById('infoMatiere').style.display = 'block';
                document.getElementById('infoMatiereNom').textContent = matiereNom;
                document.getElementById('infoMatiereCoef').textContent = matiereCoef;
                document.getElementById('infoMatiereEtudiants').textContent = etudiants.length;
                
                const notesSaisies = notes.filter(n => n.note_cc !== null || n.note_examen !== null).length;
                document.getElementById('infoMatiereNotesSaisies').textContent = notesSaisies;

                // Afficher le tableau
                const tbody = document.getElementById('tbodyNotes');
                if (etudiants.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:40px;color:rgba(255,255,255,0.5)">Aucun √©tudiant dans cette fili√®re</td></tr>';
                    return;
                }

                tbody.innerHTML = etudiants.map((e, index) => {
                    const note = notesMap[e.id];
                    const noteCC = note?.note_cc || '';
                    const noteExamen = note?.note_examen || '';
                    const moyenne = calculerMoyenne(noteCC, noteExamen);
                    const noteId = note?.id || null;

                    return `
                        <tr data-etudiant-id="${e.id}" data-note-id="${noteId || ''}">
                            <td style="text-align:center;color:rgba(255,255,255,0.5)">${index + 1}</td>
                            <td style="font-weight:600">${e.matricule}</td>
                            <td>${e.prenom} ${e.nom}</td>
                            <td><span class="badge-ultra primary">${e.niveau}</span></td>
                            <td>
                                <input type="number" 
                                    class="form-input-ultra" 
                                    style="padding:8px;text-align:center;background:rgba(255,255,255,0.05)"
                                    min="0" 
                                    max="20" 
                                    step="0.25"
                                    value="${noteCC}"
                                    placeholder="0.00"
                                    onchange="updateNote(${e.id}, 'cc', this.value)"
                                    onblur="sauvegarderNote(${e.id})">
                            </td>
                            <td>
                                <input type="number" 
                                    class="form-input-ultra" 
                                    style="padding:8px;text-align:center;background:rgba(255,255,255,0.05)"
                                    min="0" 
                                    max="20" 
                                    step="0.25"
                                    value="${noteExamen}"
                                    placeholder="0.00"
                                    onchange="updateNote(${e.id}, 'examen', this.value)"
                                    onblur="sauvegarderNote(${e.id})">
                            </td>
                            <td style="text-align:center">
                                <span style="font-weight:700;font-size:16px;color:${moyenne >= 10 ? '#10b981' : moyenne > 0 ? '#ef4444' : 'rgba(255,255,255,0.3)'}" id="moyenne-${e.id}">
                                    ${moyenne > 0 ? moyenne.toFixed(2) : '-'}
                                </span>
                            </td>
                            <td style="text-align:center">
                                <span class="badge-ultra ${moyenne >= 10 ? 'success' : moyenne > 0 ? 'danger' : ''}" id="statut-${e.id}">
                                    ${moyenne >= 10 ? 'Valid√©' : moyenne > 0 ? 'Ajourn√©' : '-'}
                                </span>
                            </td>
                            <td style="text-align:center">
                                <button class="btn-ultra btn-ghost-ultra btn-sm-ultra" onclick="supprimerNote(${e.id}, ${noteId})" title="Supprimer" ${!noteId ? 'disabled' : ''}>
                                    üóëÔ∏è
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');

                // Activer le bouton publier si des notes existent
                document.getElementById('btnPublier').disabled = notesSaisies === 0;

            } catch (err) {
                console.error('Erreur:', err);
                showToast('Erreur de chargement: ' + err.message, 'danger');
            }
        }

        function calculerMoyenne(noteCC, noteExamen) {
            const cc = parseFloat(noteCC) || 0;
            const examen = parseFloat(noteExamen) || 0;
            
            if (cc === 0 && examen === 0) return 0;
            
            return cc * 0.4 + examen * 0.6;
        }

        function updateNote(etudiantId, type, valeur) {
            if (!notesEnCours[etudiantId]) {
                notesEnCours[etudiantId] = { note_cc: null, note_examen: null };
            }
            
            if (type === 'cc') {
                notesEnCours[etudiantId].note_cc = valeur ? parseFloat(valeur) : null;
            } else {
                notesEnCours[etudiantId].note_examen = valeur ? parseFloat(valeur) : null;
            }

            // Mettre √† jour l'affichage de la moyenne
            const row = document.querySelector(`tr[data-etudiant-id="${etudiantId}"]`);
            const inputCC = row.querySelector('input[type="number"]:nth-of-type(1)');
            const inputExamen = row.querySelector('input[type="number"]:nth-of-type(2)');
            
            const moyenne = calculerMoyenne(inputCC.value, inputExamen.value);
            
            const moyenneSpan = document.getElementById(`moyenne-${etudiantId}`);
            const statutSpan = document.getElementById(`statut-${etudiantId}`);
            
            if (moyenne > 0) {
                moyenneSpan.textContent = moyenne.toFixed(2);
                moyenneSpan.style.color = moyenne >= 10 ? '#10b981' : '#ef4444';
                
                statutSpan.textContent = moyenne >= 10 ? 'Valid√©' : 'Ajourn√©';
                statutSpan.className = `badge-ultra ${moyenne >= 10 ? 'success' : 'danger'}`;
            } else {
                moyenneSpan.textContent = '-';
                moyenneSpan.style.color = 'rgba(255,255,255,0.3)';
                statutSpan.textContent = '-';
                statutSpan.className = 'badge-ultra';
            }
        }

        async function sauvegarderNote(etudiantId) {
            if (!matiereSelectionneeProf) {
                showToast('Veuillez s√©lectionner une mati√®re', 'warning');
                return;
            }

            const noteData = notesEnCours[etudiantId];
            if (!noteData) return;

            try {
                const annees = await API.getAnnees();
                const anneeActive = annees.find(a => a.active) || annees[0];

                const row = document.querySelector(`tr[data-etudiant-id="${etudiantId}"]`);
                const noteId = row.getAttribute('data-note-id');

                const data = {
                    etudiant: etudiantId,
                    matiere: matiereSelectionneeProf.id,
                    annee_academique: anneeActive.id,
                    note_cc: noteData.note_cc,
                    note_examen: noteData.note_examen,
                    publie: false
                };

                if (noteId) {
                    // Mise √† jour
                    await API.updateNote(noteId, data);
                } else {
                    // Cr√©ation
                    const newNote = await API.createNote(data);
                    row.setAttribute('data-note-id', newNote.id);
                }

                // Petit feedback visuel
                row.style.background = 'rgba(16,185,129,0.1)';
                setTimeout(() => {
                    row.style.background = '';
                }, 500);

                delete notesEnCours[etudiantId];

            } catch (err) {
                console.error('Erreur:', err);
                showToast('Erreur de sauvegarde: ' + err.message, 'danger');
            }
        }

        async function sauvegarderToutesLesNotes() {
            if (Object.keys(notesEnCours).length === 0) {
                showToast('Aucune modification √† sauvegarder', 'info');
                return;
            }

            const etudiantIds = Object.keys(notesEnCours);
            let saved = 0;

            for (const etudiantId of etudiantIds) {
                await sauvegarderNote(parseInt(etudiantId));
                saved++;
            }

            showToast(`${saved} note(s) sauvegard√©e(s) avec succ√®s`, 'success');
            chargerEtudiantsMatiere(); // Recharger pour mettre √† jour les stats
        }

        async function publierNotes() {
            if (!matiereSelectionneeProf) {
                showToast('Veuillez s√©lectionner une mati√®re', 'warning');
                return;
            }

            if (!confirm('√ätes-vous s√ªr de vouloir publier les notes ? Les √©tudiants pourront les consulter.')) {
                return;
            }

            try {
                const annees = await API.getAnnees();
                const anneeActive = annees.find(a => a.active) || annees[0];

                await API.publierNotes(matiereSelectionneeProf.id, anneeActive.id);
                showToast('Notes publi√©es avec succ√®s !', 'success');
                chargerEtudiantsMatiere();
            } catch (err) {
                console.error('Erreur:', err);
                showToast('Erreur de publication: ' + err.message, 'danger');
            }
        }

        let notesEnCours = {};
        // matiereSelectionneeProf, etudiantsMatiere, evaluationsMatiere, evaluationEnCours, notesEvalEnCours d√©j√† d√©clar√©s plus haut

        async function chargerEvaluationsMatiere() {
            const selectMatiere = document.getElementById('selectMatiereNotes');
            const matiereId = selectMatiere.value;
            
            if (!matiereId) {
                document.getElementById('contenuEvaluations').style.display = 'none';
                return;
            }

            try {
                // R√©cup√©rer les infos de la mati√®re
                const selectedOption = selectMatiere.options[selectMatiere.selectedIndex];
                const matiereNom = selectedOption.getAttribute('data-nom');
                const matiereCoef = selectedOption.getAttribute('data-coef');
                const filiereId = selectedOption.getAttribute('data-filiere');
                
                matiereSelectionneeProf = {
                    id: matiereId,
                    nom: matiereNom,
                    coefficient: matiereCoef,
                    filiere: filiereId
                };

                // R√©cup√©rer les √©tudiants de la fili√®re
                const etudiants = await API.getEtudiants({ filiere: filiereId });
                etudiantsMatiere = etudiants;

                // R√©cup√©rer l'ann√©e acad√©mique active
                const annees = await API.getAnnees();
                const anneeActive = annees.find(a => a.active) || annees[0];

                // R√©cup√©rer les √©valuations de cette mati√®re
                const evaluations = await API.getEvaluations({ 
                    matiere: matiereId,
                    annee_academique: anneeActive.id
                });
                evaluationsMatiere = evaluations;

                // R√©cup√©rer toutes les notes d'√©valuations
                const notesEvals = await API.getNotesEvaluations({ matiere: matiereId });

                // Compter les notes saisies
                const notesSaisies = notesEvals.filter(n => n.note !== null && !n.absent).length;

                // Afficher le contenu
                document.getElementById('contenuEvaluations').style.display = 'block';
                document.getElementById('statNbEvaluations').textContent = evaluations.length;
                document.getElementById('statNbEtudiants').textContent = etudiants.length;
                document.getElementById('statNotesSaisies').textContent = notesSaisies;

                // Afficher les √©valuations
                afficherEvaluations();

            } catch (err) {
                console.error('Erreur:', err);
                showToast('Erreur de chargement: ' + err.message, 'danger');
            }
        }

        function afficherEvaluations() {
            const container = document.getElementById('listeEvaluations');
            
            if (evaluationsMatiere.length === 0) {
                container.innerHTML = '<div style="text-align:center;padding:40px;color:rgba(255,255,255,0.5)">Aucune √©valuation. Cr√©ez-en une pour commencer.</div>';
                return;
            }

            const typeIcons = {
                devoir: 'üìù',
                interrogation: 'üìÑ',
                tp: 'üî¨',
                projet: 'üíº',
                examen: 'üìã',
                oral: 'üé§'
            };

            const categorieColors = {
                cc: { bg: 'rgba(99,102,241,0.1)', border: 'rgba(99,102,241,0.3)', text: '#6366f1' },
                examen: { bg: 'rgba(239,68,68,0.1)', border: 'rgba(239,68,68,0.3)', text: '#ef4444' }
            };

            container.innerHTML = evaluationsMatiere.map(eval => {
                const color = categorieColors[eval.categorie];
                return `
                    <div style="background:${color.bg};border:1px solid ${color.border};border-radius:12px;padding:20px;display:grid;grid-template-columns:1fr auto;gap:16px;align-items:start">
                        <div>
                            <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
                                <span style="font-size:24px">${typeIcons[eval.type_evaluation]}</span>
                                <div>
                                    <div style="font-size:16px;font-weight:600;color:#fff">${eval.titre}</div>
                                    <div style="font-size:13px;color:rgba(255,255,255,0.6);margin-top:2px">
                                        ${eval.type_evaluation.charAt(0).toUpperCase() + eval.type_evaluation.slice(1)} ¬∑ 
                                        <span style="color:${color.text};font-weight:600">${eval.categorie.toUpperCase()}</span> ¬∑ 
                                        Coef. ${eval.coefficient} ¬∑ 
                                        Note sur ${eval.note_sur} ¬∑ 
                                        ${formatDate(eval.date_evaluation)}
                                    </div>
                                </div>
                            </div>
                            ${eval.description ? `<div style="font-size:13px;color:rgba(255,255,255,0.6);margin-top:8px">${eval.description}</div>` : ''}
                        </div>
                        <div style="display:flex;gap:8px">
                            <button class="btn-ultra btn-primary-ultra btn-sm-ultra" onclick="ouvrirSaisieNotes(${eval.id})" style="background: linear-gradient(135deg, #10b981, #059669)">
                                üìù Saisir notes
                            </button>
                            <button class="btn-ultra btn-ghost-ultra btn-sm-ultra" onclick="modifierEvaluation(${eval.id})" title="Modifier">
                                ‚úèÔ∏è
                            </button>
                            <button class="btn-ultra btn-ghost-ultra btn-sm-ultra" onclick="supprimerEvaluation(${eval.id})" title="Supprimer">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function ouvrirModalEvaluation() {
            document.getElementById('modalEvaluationTitle').textContent = 'üìù Nouvelle √©valuation';
            document.getElementById('editEvalId').value = '';
            document.getElementById('formEvaluation').reset();
            
            // Date par d√©faut: aujourd'hui
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('editEvalDate').value = today;
            
            openModal('modalEvaluation');
        }

        async function modifierEvaluation(evalId) {
            try {
                const evaluation = await API.getEvaluation(evalId);
                
                document.getElementById('modalEvaluationTitle').textContent = '‚úèÔ∏è Modifier l\'√©valuation';
                document.getElementById('editEvalId').value = evaluation.id;
                document.getElementById('editEvalTitre').value = evaluation.titre;
                document.getElementById('editEvalType').value = evaluation.type_evaluation;
                document.getElementById('editEvalCategorie').value = evaluation.categorie;
                document.getElementById('editEvalCoef').value = evaluation.coefficient;
                document.getElementById('editEvalNoteSur').value = evaluation.note_sur;
                document.getElementById('editEvalDate').value = evaluation.date_evaluation;
                document.getElementById('editEvalDescription').value = evaluation.description || '';
                
                openModal('modalEvaluation');
            } catch (err) {
                console.error('Erreur:', err);
                showToast('Erreur de chargement: ' + err.message, 'danger');
            }
        }

        async function sauvegarderEvaluation(event) {
            event.preventDefault();
            
            if (!matiereSelectionneeProf) {
                showToast('Veuillez s√©lectionner une mati√®re', 'warning');
                return;
            }

            try {
                const form = event.target;
                const evalId = document.getElementById('editEvalId').value;
                
                // R√©cup√©rer l'ann√©e acad√©mique active
                const annees = await API.getAnnees();
                const anneeActive = annees.find(a => a.active) || annees[0];

                const data = {
                    matiere: matiereSelectionneeProf.id,
                    annee_academique: anneeActive.id,
                    titre: form.titre.value,
                    type_evaluation: form.type_evaluation.value,
                    categorie: form.categorie.value,
                    coefficient: parseInt(form.coefficient.value),
                    note_sur: parseFloat(form.note_sur.value),
                    date_evaluation: form.date_evaluation.value,
                    description: form.description.value
                };

                if (evalId) {
                    // Modification
                    await API.updateEvaluation(evalId, data);
                    showToast('√âvaluation modifi√©e avec succ√®s', 'success');
                } else {
                    // Cr√©ation
                    const newEval = await API.createEvaluation(data);
                    showToast('√âvaluation cr√©√©e avec succ√®s', 'success');
                    
                    // G√©n√©rer les notes vides pour tous les √©tudiants
                    await API.genererNotesEvaluation(newEval.id);
                }

                closeModal('modalEvaluation');
                chargerEvaluationsMatiere();

            } catch (err) {
                console.error('Erreur:', err);
                showToast('Erreur: ' + err.message, 'danger');
            }
        }

        async function supprimerEvaluation(evalId) {
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette √©valuation ? Toutes les notes associ√©es seront √©galement supprim√©es.')) {
                return;
            }

            try {
                await API.deleteEvaluation(evalId);
                showToast('√âvaluation supprim√©e', 'success');
                chargerEvaluationsMatiere();
            } catch (err) {
                console.error('Erreur:', err);
                showToast('Erreur: ' + err.message, 'danger');
            }
        }

        async function ouvrirSaisieNotes(evalId) {
            try {
                // R√©cup√©rer l'√©valuation
                const evaluation = await API.getEvaluation(evalId);
                evaluationEnCours = evaluation;

                // R√©cup√©rer les notes de cette √©valuation
                const notes = await API.getNotesEvaluations({ evaluation: evalId });
                
                // Cr√©er un map des notes par √©tudiant
                const notesMap = {};
                notes.forEach(n => {
                    notesMap[n.etudiant] = n;
                });

                // Afficher les infos de l'√©valuation
                const typeIcons = {
                    devoir: 'üìù',
                    interrogation: 'üìÑ',
                    tp: 'üî¨',
                    projet: 'üíº',
                    examen: 'üìã',
                    oral: 'üé§'
                };

                document.getElementById('infoEvaluation').innerHTML = `
                    <div style="display:flex;align-items:center;gap:12px">
                        <span style="font-size:28px">${typeIcons[evaluation.type_evaluation]}</span>
                        <div style="flex:1">
                            <div style="font-size:16px;font-weight:600;color:#fff">${evaluation.titre}</div>
                            <div style="font-size:13px;color:rgba(255,255,255,0.7);margin-top:4px">
                                ${evaluation.type_evaluation.charAt(0).toUpperCase() + evaluation.type_evaluation.slice(1)} ¬∑ 
                                ${evaluation.categorie.toUpperCase()} ¬∑ 
                                Coef. ${evaluation.coefficient} ¬∑ 
                                Note sur ${evaluation.note_sur} ¬∑ 
                                ${formatDate(evaluation.date_evaluation)}
                            </div>
                        </div>
                    </div>
                `;

                // Afficher le tableau des √©tudiants
                const tbody = document.getElementById('tbodyNotesEval');
                tbody.innerHTML = etudiantsMatiere.map((e, index) => {
                    const note = notesMap[e.id];
                    const noteValue = note?.note || '';
                    const absent = note?.absent || false;
                    const commentaire = note?.commentaire || '';
                    const noteId = note?.id || null;

                    return `
                        <tr data-etudiant-id="${e.id}" data-note-id="${noteId || ''}">
                            <td style="text-align:center;color:rgba(255,255,255,0.5)">${index + 1}</td>
                            <td style="font-weight:600">${e.matricule}</td>
                            <td>${e.prenom} ${e.nom}</td>
                            <td>
                                <input type="number" 
                                    class="form-input-ultra" 
                                    style="padding:8px;text-align:center;background:rgba(255,255,255,0.05)"
                                    min="0" 
                                    max="${evaluation.note_sur}" 
                                    step="0.25"
                                    value="${noteValue}"
                                    placeholder="0.00"
                                    ${absent ? 'disabled' : ''}
                                    onchange="updateNoteEval(${e.id}, this.value)">
                            </td>
                            <td style="text-align:center">
                                <input type="checkbox" 
                                    ${absent ? 'checked' : ''}
                                    onchange="toggleAbsent(${e.id}, this.checked)"
                                    style="width:20px;height:20px;cursor:pointer">
                            </td>
                            <td>
                                <input type="text" 
                                    class="form-input-ultra" 
                                    style="padding:8px;font-size:12px;background:rgba(255,255,255,0.05)"
                                    value="${commentaire}"
                                    placeholder="Commentaire..."
                                    onchange="updateCommentaire(${e.id}, this.value)">
                            </td>
                        </tr>
                    `;
                }).join('');

                // Mettre √† jour le compteur
                const notesSaisies = notes.filter(n => n.note !== null || n.absent).length;
                document.getElementById('progressNotes').textContent = `${notesSaisies}/${etudiantsMatiere.length} notes saisies`;

                openModal('modalSaisieNotes');

            } catch (err) {
                console.error('Erreur:', err);
                showToast('Erreur: ' + err.message, 'danger');
            }
        }

        function updateNoteEval(etudiantId, valeur) {
            if (!notesEvalEnCours[etudiantId]) {
                notesEvalEnCours[etudiantId] = {};
            }
            notesEvalEnCours[etudiantId].note = valeur ? parseFloat(valeur) : null;
        }

        function toggleAbsent(etudiantId, absent) {
            if (!notesEvalEnCours[etudiantId]) {
                notesEvalEnCours[etudiantId] = {};
            }
            notesEvalEnCours[etudiantId].absent = absent;

            // D√©sactiver/activer le champ de note
            const row = document.querySelector(`#tbodyNotesEval tr[data-etudiant-id="${etudiantId}"]`);
            const inputNote = row.querySelector('input[type="number"]');
            inputNote.disabled = absent;
            if (absent) {
                inputNote.value = '';
                notesEvalEnCours[etudiantId].note = null;
            }
        }

        function updateCommentaire(etudiantId, commentaire) {
            if (!notesEvalEnCours[etudiantId]) {
                notesEvalEnCours[etudiantId] = {};
            }
            notesEvalEnCours[etudiantId].commentaire = commentaire;
        }

        async function sauvegarderToutesNotesEval() {
            if (!evaluationEnCours) {
                showToast('Aucune √©valuation s√©lectionn√©e', 'warning');
                return;
            }

            try {
                let saved = 0;
                const rows = document.querySelectorAll('#tbodyNotesEval tr');

                for (const row of rows) {
                    const etudiantId = parseInt(row.getAttribute('data-etudiant-id'));
                    const noteId = row.getAttribute('data-note-id');
                    
                    const inputNote = row.querySelector('input[type="number"]');
                    const inputAbsent = row.querySelector('input[type="checkbox"]');
                    const inputCommentaire = row.querySelector('input[type="text"]');

                    const data = {
                        evaluation: evaluationEnCours.id,
                        etudiant: etudiantId,
                        note: inputNote.value ? parseFloat(inputNote.value) : null,
                        absent: inputAbsent.checked,
                        commentaire: inputCommentaire.value
                    };

                    if (noteId) {
                        // Mise √† jour
                        await API.updateNoteEvaluation(noteId, data);
                    } else {
                        // Cr√©ation
                        const newNote = await API.createNoteEvaluation(data);
                        row.setAttribute('data-note-id', newNote.id);
                    }
                    saved++;
                }

                showToast(`${saved} note(s) sauvegard√©e(s) avec succ√®s`, 'success');
                notesEvalEnCours = {};
                
                // Mettre √† jour le compteur
                const notes = await API.getNotesEvaluations({ evaluation: evaluationEnCours.id });
                const notesSaisies = notes.filter(n => n.note !== null || n.absent).length;
                document.getElementById('progressNotes').textContent = `${notesSaisies}/${etudiantsMatiere.length} notes saisies`;
                
                // Recharger les stats
                chargerEvaluationsMatiere();

            } catch (err) {
                console.error('Erreur:', err);
                showToast('Erreur de sauvegarde: ' + err.message, 'danger');
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const user = requireAuth(['professeur']);
            if (user) {
                chargerMatieres();
                chargerSupports();
                chargerDashboard();
                chargerMatieresNotes();
            }
        });
    </script>
</body>
</html>

                        <tr>
                            <td>${index + 1}</td>
                            <td>${e.matricule}</td>
                            <td>${e.prenom} ${e.nom}</td>
                            <td>
                                <input type="number" 
                                    class="form-input-ultra" 
                                    style="width:80px;padding:8px;text-align:center" 
                                    min="0" 
                                    max="${evaluation.note_sur}" 
                                    step="0.5"
                                    value="${noteValue}"
                                    ${absent ? 'disabled' : ''}
                                    onchange="sauvegarderNote(${e.id}, this.value, ${noteId}, ${absent})"
                                    placeholder="Note">
                            </td>
                            <td>
                                <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                                    <input type="checkbox" 
                                        ${absent ? 'checked' : ''}
                                        onchange="toggleAbsent(${e.id}, this.checked, ${noteId})">
                                    <span style="font-size:13px">${absent ? 'Absent' : 'Pr√©sent'}</span>
                                </label>
                            </td>
                            <td>
                                <input type="text" 
                                    class="form-input-ultra" 
                                    style="width:200px;padding:8px;font-size:13px" 
                                    value="${commentaire}"
                                    onchange="sauvegarderCommentaire(${e.id}, this.value, ${noteId})"
                                    placeholder="Commentaire...">
                            </td>
                        </tr>
                    `;
                }).join('');

                openModal('modalSaisieNotes');
            } catch (err) {
                console.error('Erreur:', err);
                showToast('Erreur: ' + err.message, 'danger');
            }
        }

        async function sauvegarderNote(etudiantId, note, noteId, absent) {
            if (absent) return;
            
            try {
                const data = {
                    evaluation: evaluationEnCours.id,
                    etudiant: etudiantId,
                    note: parseFloat(note) || null,
                    absent: false
                };

                if (noteId) {
                    await API.updateNoteEvaluation(noteId, data);
                } else {
                    await API.createNoteEvaluation(data);
                }
                
                showToast('Note enregistr√©e', 'success');
            } catch (err) {
                console.error('Erreur:', err);
                showToast('Erreur: ' + err.message, 'danger');
            }
        }

        async function toggleAbsent(etudiantId, absent, noteId) {
            try {
                const data = {
                    evaluation: evaluationEnCours.id,
                    etudiant: etudiantId,
                    absent: absent,
                    note: absent ? null : 0
                };

                if (noteId) {
                    await API.updateNoteEvaluation(noteId, data);
                } else {
                    await API.createNoteEvaluation(data);
                }
                
                ouvrirSaisieNotes(evaluationEnCours.id);
            } catch (err) {
                console.error('Erreur:', err);
                showToast('Erreur: ' + err.message, 'danger');
            }
        }

        async function sauvegarderCommentaire(etudiantId, commentaire, noteId) {
            try {
                const data = {
                    evaluation: evaluationEnCours.id,
                    etudiant: etudiantId,
                    commentaire: commentaire
                };

                if (noteId) {
                    await API.updateNoteEvaluation(noteId, data);
                } else {
                    await API.createNoteEvaluation(data);
                }
            } catch (err) {
                console.error('Erreur:', err);
            }
        }

        // ===== R√âCLAMATIONS =====
        let toutesReclamations = [];
        let reclamationSelectionnee = null;

        async function chargerReclamations() {
            try {
                const reclamations = await API.get('/reclamations/');
                toutesReclamations = reclamations;
                
                // Mettre √† jour le badge
                const enAttente = reclamations.filter(r => r.statut === 'en_attente').length;
                document.getElementById('badgeReclamations').textContent = enAttente;
                
                afficherReclamations(reclamations);
            } catch (err) {
                console.error('Erreur:', err);
                showToast('Erreur lors du chargement des r√©clamations', 'danger');
            }
        }

        function afficherReclamations(reclamations) {
            const tbody = document.getElementById('tbodyReclamationsProf');
            
            if (!reclamations || reclamations.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;color:rgba(255,255,255,0.5)">Aucune r√©clamation</td></tr>';
                return;
            }
            
            tbody.innerHTML = reclamations.map(r => {
                const badgeClass = {
                    'en_attente': 'warning',
                    'resolue': 'success',
                    'rejetee': 'danger'
                }[r.statut] || 'secondary';
                
                return `
                    <tr>
                        <td>${r.note?.etudiant?.nom || 'N/A'} ${r.note?.etudiant?.prenom || ''}</td>
                        <td>${r.note?.matiere?.nom || 'N/A'}</td>
                        <td>${r.note?.note_cc !== null ? r.note.note_cc.toFixed(2) : '-'}</td>
                        <td>${r.note?.note_examen !== null ? r.note.note_examen.toFixed(2) : '-'}</td>
                        <td><strong>${r.note?.moyenne !== null ? r.note.moyenne.toFixed(2) : '-'}</strong></td>
                        <td>${new Date(r.date_creation).toLocaleDateString('fr-FR')}</td>
                        <td><span class="badge-ultra ${badgeClass}">${r.statut}</span></td>
                        <td>
                            ${r.statut === 'en_attente' ? 
                                `<button onclick="traiterReclamation(${r.id})" class="btn-ultra btn-sm-ultra btn-primary-ultra">
                                    Traiter
                                </button>` : 
                                `<button onclick="voirReclamationProf(${r.id})" class="btn-ultra btn-sm-ultra btn-ghost-ultra">
                                    Voir
                                </button>`
                            }
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function filtrerReclamationsProf() {
            const statut = document.getElementById('filtreStatutReclamationProf').value;
            
            let filtrees = toutesReclamations;
            
            if (statut) {
                filtrees = filtrees.filter(r => r.statut === statut);
            }
            
            afficherReclamations(filtrees);
        }

        function voirReclamationProf(id) {
            const reclamation = toutesReclamations.find(r => r.id === id);
            if (!reclamation) return;
            
            const details = document.getElementById('detailsReclamationProf');
            details.innerHTML = `
                <div class="detail-row">
                    <strong>√âtudiant:</strong> ${reclamation.note?.etudiant?.nom || 'N/A'} ${reclamation.note?.etudiant?.prenom || ''}
                </div>
                <div class="detail-row">
                    <strong>Mati√®re:</strong> ${reclamation.note?.matiere?.nom || 'N/A'}
                </div>
                <div class="detail-row">
                    <strong>Notes actuelles:</strong><br>
                    <div style="margin-top:10px;padding:15px;background:rgba(255,255,255,0.05);border-radius:8px;">
                        CC: ${reclamation.note?.note_cc !== null ? reclamation.note.note_cc.toFixed(2) : '-'}/20<br>
                        Examen: ${reclamation.note?.note_examen !== null ? reclamation.note.note_examen.toFixed(2) : '-'}/20<br>
                        <strong>Moyenne: ${reclamation.note?.moyenne !== null ? reclamation.note.moyenne.toFixed(2) : '-'}/20</strong>
                    </div>
                </div>
                <div class="detail-row">
                    <strong>Description:</strong><br>
                    <p style="margin-top:10px;padding:15px;background:rgba(255,255,255,0.05);border-radius:8px;">
                        ${reclamation.description || 'Aucune description'}
                    </p>
                </div>
                ${reclamation.reponse_enseignant ? `
                    <div class="detail-row">
                        <strong>Votre r√©ponse:</strong><br>
                        <p style="margin-top:10px;padding:15px;background:rgba(76,175,80,0.1);border-radius:8px;border-left:3px solid #4CAF50;">
                            ${reclamation.reponse_enseignant}
                        </p>
                    </div>
                ` : ''}
            `;
            
            openModal('modalVoirReclamationProf');
        }

        function traiterReclamation(id) {
            const reclamation = toutesReclamations.find(r => r.id === id);
            if (!reclamation) return;
            
            reclamationSelectionnee = reclamation;
            
            document.getElementById('reclamationInfo').innerHTML = `
                <strong>${reclamation.note?.etudiant?.nom || 'N/A'} ${reclamation.note?.etudiant?.prenom || ''}</strong> - ${reclamation.note?.matiere?.nom || 'N/A'}<br>
                <span style="font-size:13px;color:rgba(255,255,255,0.7)">
                    Note actuelle: ${reclamation.note?.moyenne !== null ? reclamation.note.moyenne.toFixed(2) : '-'}/20
                </span>
            `;
            
            document.getElementById('reclamationDescription').textContent = reclamation.description || 'Aucune description';
            
            // Pr√©-remplir les notes actuelles
            document.getElementById('nouvelleNoteCC').value = reclamation.note?.note_cc || '';
            document.getElementById('nouvelleNoteExamen').value = reclamation.note?.note_examen || '';
            
            document.getElementById('formTraiterReclamation').reset();
            document.getElementById('decisionReclamation').value = '';
            document.getElementById('reponseReclamation').value = '';
            document.getElementById('correctionNote').style.display = 'none';
            
            openModal('modalTraiterReclamation');
        }

        // Afficher/masquer la section correction
        document.addEventListener('DOMContentLoaded', () => {
            const decisionSelect = document.getElementById('decisionReclamation');
            if (decisionSelect) {
                decisionSelect.addEventListener('change', (e) => {
                    const correctionDiv = document.getElementById('correctionNote');
                    correctionDiv.style.display = e.target.value === 'resolue' ? 'block' : 'none';
                });
            }
        });

        async function envoyerTraitementReclamation(event) {
            event.preventDefault();
            
            if (!reclamationSelectionnee) return;
            
            const decision = document.getElementById('decisionReclamation').value;
            const reponse = document.getElementById('reponseReclamation').value;
            const corriger = decision === 'resolue';
            
            const data = {
                statut: decision,
                reponse_enseignant: reponse,
                corriger_note: corriger
            };
            
            if (corriger) {
                const noteCC = document.getElementById('nouvelleNoteCC').value;
                const noteExamen = document.getElementById('nouvelleNoteExamen').value;
                
                if (noteCC) data.nouvelle_note_cc = parseFloat(noteCC);
                if (noteExamen) data.nouvelle_note_examen = parseFloat(noteExamen);
            }
            
            try {
                await API.post(`/reclamations/${reclamationSelectionnee.id}/traiter/`, data);
                showToast('R√©clamation trait√©e avec succ√®s', 'success');
                closeModal('modalTraiterReclamation');
                chargerReclamations();
            } catch (err) {
                console.error('Erreur:', err);
                showToast('Erreur lors du traitement: ' + err.message, 'danger');
            }
        }

        // Initialisation
        window.addEventListener('DOMContentLoaded', () => {
            chargerDonnees();
            chargerReclamations();
        });
    </script>
    <style>
        .detail-row {
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .detail-row:last-child {
            border-bottom: none;
        }
        .detail-row strong {
            color: rgba(255,255,255,0.7);
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
    </style>
</body>
</html>
